# Task #9 - private_endpoint_vnet_policies - Proof Document

## Shadow Implementation

```hcl
# variables.tf
variable "private_endpoint_vnet_policies" {
  type        = string
  default     = "Disabled"  # <-
  description = "(Optional) The Private Endpoint VNet Policies for the Virtual Network. Possible values are `Disabled` and `Basic`. Defaults to `Disabled`."
  nullable    = false  # <-
  
  validation {  # <-
    condition = contains(["Disabled", "Basic"], var.private_endpoint_vnet_policies)  # <-
    error_message = "The private_endpoint_vnet_policies must be either 'Disabled' or 'Basic'."  # <-
  }  # <-
}

# migrate_main.tf
locals {
  body = {
    properties = {
      privateEndpointVNetPolicies = var.private_endpoint_vnet_policies  # <-
    }
  }
}
```

## Summary

Implemented `private_endpoint_vnet_policies` as a root-level optional argument with default value "Disabled" and validation for allowed values ["Disabled", "Basic"], mapped to `properties.privateEndpointVNetPolicies` in Azure API, following exact provider behavior including default value and validation logic.

## Create Phase Verification

**Query Result from Create Method:**

From `resourceVirtualNetworkCreate`:
```go
func resourceVirtualNetworkCreate(d *pluginsdk.ResourceData, meta interface{}) error {
	// ...
	vnetProperties, routeTables, err := expandVirtualNetworkProperties(ctx, *client, id, d)
	if err != nil {
		return err
	}
	// ...
	vnet := virtualnetworks.VirtualNetwork{
		Name:             pointer.To(id.VirtualNetworkName),
		ExtendedLocation: expandEdgeZoneModel(d.Get("edge_zone").(string)),
		Location:         pointer.To(location.Normalize(d.Get("location").(string))),
		Properties:       vnetProperties,  // <-- Properties assigned here
		Tags:             tags.Expand(d.Get("tags").(map[string]interface{})),
	}
	// ...
	if err := client.CreateOrUpdateThenPoll(ctx, id, vnet); err != nil {
		return fmt.Errorf("creating %s: %+v", id, err)
	}
	// ...
}
```

From `expandVirtualNetworkProperties`:
```go
func expandVirtualNetworkProperties(ctx context.Context, client virtualnetworks.VirtualNetworksClient, id commonids.VirtualNetworkId, d *pluginsdk.ResourceData) (*virtualnetworks.VirtualNetworkPropertiesFormat, *[]string, error) {
	// ...
	properties := &virtualnetworks.VirtualNetworkPropertiesFormat{
		AddressSpace: &virtualnetworks.AddressSpace{},
		DhcpOptions: &virtualnetworks.DhcpOptions{
			DnsServers: utils.ExpandStringSlice(d.Get("dns_servers").([]interface{})),
		},
		PrivateEndpointVNetPolicies: pointer.To(virtualnetworks.PrivateEndpointVNetPolicies(d.Get("private_endpoint_vnet_policies").(string))),  // <-- Set during Create
		Subnets:                     &subnets,
	}
	// ...
	return properties, &routeTables, nil
}
```

**Pattern Identification:**
- **Single-phase operation**: Only `CreateOrUpdateThenPoll` is called
- **No post-operations**: No additional SDK operations after primary create

**Field Classification:**
- **Phase**: Create phase (set in `expandVirtualNetworkProperties` before `CreateOrUpdateThenPoll`)
- **Assignment**: Direct assignment in properties struct construction
- **Location**: `local.body.properties`

**Decision**: Field belongs in `local.body.properties.privateEndpointVNetPolicies`

## Assignment Path Verification

**Predicted Path**: `body.properties.privateEndpointVNetPolicies`

**Go Code Evidence**:

1. In `expandVirtualNetworkProperties`:
```go
properties := &virtualnetworks.VirtualNetworkPropertiesFormat{
	// ...
	PrivateEndpointVNetPolicies: pointer.To(virtualnetworks.PrivateEndpointVNetPolicies(d.Get("private_endpoint_vnet_policies").(string))),
	// ...
}
```
→ Creates `VirtualNetworkPropertiesFormat` struct with `PrivateEndpointVNetPolicies` field set

2. In `resourceVirtualNetworkCreate`:
```go
vnet := virtualnetworks.VirtualNetwork{
	// ...
	Properties: vnetProperties,  // <-- Assigns properties struct to Properties field
	// ...
}
```
→ Assigns to `.Properties` of `VirtualNetwork` struct

3. API call:
```go
if err := client.CreateOrUpdateThenPoll(ctx, id, vnet); err != nil {
```
→ Sends `vnet` object which has structure: `{Properties: {PrivateEndpointVNetPolicies: value}}`

**Verified Path**: `properties.privateEndpointVNetPolicies`

**Path Comparison**: ✅ MATCH - Predicted path matches verified path

## Provider Schema

**Schema Definition**:
```go
"private_endpoint_vnet_policies": {
	Type:         pluginsdk.TypeString,
	Optional:     true,
	Default:      string(virtualnetworks.PrivateEndpointVNetPoliciesDisabled),
	ValidateFunc: validation.StringInSlice(virtualnetworks.PossibleValuesForPrivateEndpointVNetPolicies(), false),
},
```

**Field Properties:**
- **Type**: String
- **Required**: No (Optional: true)
- **Default**: "Disabled" (virtualnetworks.PrivateEndpointVNetPoliciesDisabled)
- **ForceNew**: No (not present)
- **Computed**: No
- **Validation**: StringInSlice with possible values from `virtualnetworks.PossibleValuesForPrivateEndpointVNetPolicies()`

**Validation Evidence**:
The validation function references `virtualnetworks.PossibleValuesForPrivateEndpointVNetPolicies()` which returns the enum values. Based on the constant naming pattern (`PrivateEndpointVNetPoliciesDisabled`) and the provider description, the possible values are:
- "Disabled"
- "Basic"

## Azure API Schema

**Resource Type**: `Microsoft.Network/virtualNetworks@2024-07-01`

**Field Path**: `body.properties.privateEndpointVNetPolicies`

**Type**: String

**From schema query**: Confirmed that `privateEndpointVNetPolicies` is a String field within the `properties` object.

## Hidden Fields

None. The field is explicitly declared in the schema and directly maps to the user-provided variable.

## Mapping

**Terraform (snake_case)** → **Azure API (camelCase)**
- `private_endpoint_vnet_policies` → `privateEndpointVNetPolicies`

## Special Handling

### 1. Default Value

**Provider Behavior**:
```go
Default: string(virtualnetworks.PrivateEndpointVNetPoliciesDisabled),
```

The provider sets a default value of "Disabled" when the field is not specified.

**Replication**:
```hcl
variable "private_endpoint_vnet_policies" {
  type        = string
  default     = "Disabled"
  nullable    = false
}
```

**Rationale**: Since this is a root-level argument with a default, we set both `default = "Disabled"` and `nullable = false` as per executor.md rules for top-level arguments with defaults.

### 2. Validation

**Provider Validation**:
```go
ValidateFunc: validation.StringInSlice(virtualnetworks.PossibleValuesForPrivateEndpointVNetPolicies(), false),
```

The provider validates that the value is one of the allowed enum values: "Disabled" or "Basic".

**Replication in variables.tf**:
```hcl
validation {
  condition = contains(["Disabled", "Basic"], var.private_endpoint_vnet_policies)
  error_message = "The private_endpoint_vnet_policies must be either 'Disabled' or 'Basic'."
}
```

**Evidence**: Validation replicates exact provider behavior by ensuring only "Disabled" or "Basic" are accepted.

### 3. ForceNew Analysis

**Provider Schema**: No `ForceNew: true` present in schema definition.

**Update Method Evidence**:
```go
func resourceVirtualNetworkUpdate(d *pluginsdk.ResourceData, meta interface{}) error {
	// ...
	if d.HasChange("private_endpoint_vnet_policies") {
		payload.Properties.PrivateEndpointVNetPolicies = pointer.To(virtualnetworks.PrivateEndpointVNetPolicies(d.Get("private_endpoint_vnet_policies").(string)))
	}
	// ...
	if err := client.CreateOrUpdateThenPoll(ctx, *id, *payload); err != nil {
		return fmt.Errorf("updating %s: %+v", id, err)
	}
	// ...
}
```

**Analysis**: 
- The Update method explicitly handles changes to `private_endpoint_vnet_policies`
- Changes are applied via `CreateOrUpdateThenPoll` (in-place update)
- No CustomizeDiff function adds ForceNew logic for this field

**Conclusion**: ✅ Field is NOT ForceNew - updates are supported in-place

**Implementation**: Field value added directly to `local.body.properties` without any ForceNew trigger.

### 4. Sensitive/WriteOnly

**Analysis**: No `Sensitive: true` or WriteOnly indication in schema or API documentation.

**Implementation**: Field added to `local.body` (not `sensitive_body`).

## Deferred Work Completion

**Check following.md**: No `following.md` file exists, so no deferred work to complete for this task.

## Critical Review & Edge Case Analysis

### Null Semantics

**Question**: What does null mean for this field?

**Answer**: 
- With `default = "Disabled"` and `nullable = false`, null is NOT allowed
- The variable always has a value (either user-provided or default "Disabled")
- This matches provider behavior where the schema has `Default:` set

**Implementation**: Direct assignment `privateEndpointVNetPolicies = var.private_endpoint_vnet_policies` is safe since the variable is never null.

### Edge Cases

1. **Empty string**: 
   - Validation prevents empty string (must be "Disabled" or "Basic")
   - Matches provider validation behavior

2. **Case sensitivity**:
   - Provider validation uses `StringInSlice(..., false)` - case-sensitive
   - Our validation uses `contains()` with exact string matches - case-sensitive
   - ✅ Behavior matches exactly

3. **Invalid values**:
   - Provider: Validation error at plan time
   - Replicator: Validation error at plan time via validation block
   - ✅ Behavior matches exactly

### Idempotency

**Analysis**: 
- Field is a simple string assignment
- No order-dependent logic
- No transformations applied
- Value is used directly as provided (or default)

**Conclusion**: ✅ Implementation is idempotent

### Safe References

**Analysis**:
- `var.private_endpoint_vnet_policies` is never null (nullable = false, default provided)
- No nested property access
- Direct string assignment

**Conclusion**: ✅ All references are safe

## Checklist

- ✅ Property in correct local (`local.body.properties.privateEndpointVNetPolicies`)
- ✅ ForceNew: Not applicable (field is not ForceNew)
- ✅ ALL logic EXACTLY replicated from provider
  - ✅ Default value "Disabled" replicated
  - ✅ Validation for ["Disabled", "Basic"] replicated
  - ✅ Nullable=false for root-level argument with default
- ✅ Validations IMPLEMENTED in variables.tf (MANDATORY)
  - ✅ String enum validation added
- ✅ TODO comment: Not applicable (not a sensitive field requiring independent ephemeral variable)
- ✅ Hidden fields checked: None found
- ✅ Deferred work in following.md: Not applicable (no work deferred to other tasks)
- ✅ Deferred work from following.md: None (file doesn't exist)
- ✅ Critical review completed (null, edge, idempotent, safe refs)
- ✅ Edge Case Analysis in proof
- ✅ Proof created
- ✅ Self-Review: Only added what Task #9 requires (private_endpoint_vnet_policies field only)

---

## ✅ CHECKER VALIDATION - APPROVED

**Checked by:** Checker Agent
**Date:** 2026-01-06
**Task:** #9 - private_endpoint_vnet_policies

### Validation Results

✅ **ForceNew Logic:** Not ForceNew - field is updateable per Update method evidence
✅ **Stable Keys:** All keys stable - direct property assignment, no conditional merge
✅ **Phase Detection:** Field correctly placed in `local.body` (Create phase)
✅ **Type Conversion:** Correct - string to string, no conversion needed
✅ **Null Handling:** Correctly enforced non-null with `nullable = false` and `default = "Disabled"`
✅ **Validations:** All provider validations implemented in variables.tf validation block
  - Enum validation: `contains(["Disabled", "Basic"], var.private_endpoint_vnet_policies)`
✅ **Root-Level Default:** Correctly includes both `default = "Disabled"` AND `nullable = false` per executor.md line 404-434
✅ **Deferred Work Completion:** No deferred work for this task (following.md does not exist)
✅ **Deferred Work Recording:** No deferrals made by this task
✅ **Edge Cases:** All edge cases properly analyzed (empty string, case sensitivity, invalid values)
✅ **Proof Document Quality:** Complete with all MANDATORY sections (Create Phase, Assignment Path, Provider Schema, Azure API Schema, ForceNew Analysis, Critical Review)

### Compliance Statement

This implementation EXACTLY replicates the provider behavior as required by `executor.md`. The implementation:
- Replicates default value "Disabled" with proper `nullable = false` constraint
- Replicates validation logic using `contains()` for enum values ["Disabled", "Basic"]
- Correctly determines field is NOT ForceNew (updateable) with Update method evidence
- Places field in correct local (`body.properties.privateEndpointVNetPolicies`)
- No deviations, simplifications, or "safer alternatives" were found

**Status:** APPROVED ✅

---
