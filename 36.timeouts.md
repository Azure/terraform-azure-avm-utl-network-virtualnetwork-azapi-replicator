# Task #36 - timeouts Block Structure Skeleton

## Summary
Created structure skeleton for the root-level `timeouts` block from `azurerm_virtual_network`. This is a Terraform provider meta-argument (not an Azure API property) that controls operation timeout durations. Updated `variables.tf` with default timeout values extracted from provider source code and added output in `migrate_outputs.tf`. No shadow module implementation required as timeouts are handled directly by parent module's `azapi_resource` block.

## Provider Schema Evidence

From `resourceVirtualNetwork()` in `github.com/hashicorp/terraform-provider-azurerm/internal/services/network`:

```go
func resourceVirtualNetwork() *pluginsdk.Resource {
	return &pluginsdk.Resource{
		Create:   resourceVirtualNetworkCreate,
		Read:     resourceVirtualNetworkRead,
		Update:   resourceVirtualNetworkUpdate,
		Delete:   resourceVirtualNetworkDelete,
		Importer: pluginsdk.ImporterValidatingIdentity(&commonids.VirtualNetworkId{}),

		Timeouts: &pluginsdk.ResourceTimeout{
			Create: pluginsdk.DefaultTimeout(30 * time.Minute),  // <- 30 minutes
			Read:   pluginsdk.DefaultTimeout(5 * time.Minute),   // <- 5 minutes
			Update: pluginsdk.DefaultTimeout(30 * time.Minute),  // <- 30 minutes
			Delete: pluginsdk.DefaultTimeout(30 * time.Minute),  // <- 30 minutes
		},

		Schema: resourceVirtualNetworkSchema(),

		Identity: &schema.ResourceIdentity{
			SchemaFunc: pluginsdk.GenerateIdentitySchema(&commonids.VirtualNetworkId{}),
		},
	}
}
```

**Default Timeout Values:**
- **Create:** 30 minutes (`30 * time.Minute`)
- **Read:** 5 minutes (`5 * time.Minute`)
- **Update:** 30 minutes (`30 * time.Minute`)
- **Delete:** 30 minutes (`30 * time.Minute`)

## Timeouts Block Structure

The `timeouts` block is a **meta-argument** at the Terraform resource level, not a property in the Azure API request body. It is configured directly in the `azapi_resource` block in the parent module.

### Fields in timeouts Block

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| `create` | `string` | No | Timeout for create operations. Default: 30m |
| `delete` | `string` | No | Timeout for delete operations. Default: 30m |
| `read` | `string` | No | Timeout for read operations. Default: 5m |
| `update` | `string` | No | Timeout for update operations. Default: 30m |

All four timeout fields are optional and have default values from the provider schema.

## Implementation

### 1. Updated `variables.tf`

Updated the `timeouts` variable with correct default values and synchronized type definitions:

```hcl
variable "timeouts" {
  type = object({
    create = optional(string, "30m")  # <- Matches default block
    delete = optional(string, "30m")  # <- Matches default block
    read   = optional(string, "5m")   # <- Matches default block
    update = optional(string, "30m")  # <- Matches default block
  })
  default     = {
    create = "30m"  # <- Synchronized with type definition
    delete = "30m"  # <- Synchronized with type definition
    read   = "5m"   # <- Synchronized with type definition
    update = "30m"  # <- Synchronized with type definition
  }
  nullable    = false  # <- Required: prevents null values
  description = <<-EOT
 - `create` - (Optional) Specifies the timeout for create operations. Defaults to 30 minutes.
 - `delete` - (Optional) Specifies the timeout for delete operations. Defaults to 30 minutes.
 - `read` - (Optional) Specifies the timeout for read operations. Defaults to 5 minutes.
 - `update` - (Optional) Specifies the timeout for update operations. Defaults to 30 minutes.
EOT
}
```

**Critical Synchronization:**
- Each field in `type` definition: `optional(string, "XXm")` matches exactly with `default` block value
- `nullable = false` is set to prevent null values (required per `timeouts.md`)
- Descriptions updated with correct default durations

### 2. Added Output in `migrate_outputs.tf`

Added the `timeouts` output to allow parent module to pass the value directly to its `azapi_resource` block:

```hcl
output "timeouts" { value = var.timeouts }  # <- New output
```

This output enables the parent module to configure:
```hcl
resource "azapi_resource" "this" {
  # ... other config ...
  timeouts {
    create = module.shadow.timeouts.create
    delete = module.shadow.timeouts.delete
    read   = module.shadow.timeouts.read
    update = module.shadow.timeouts.update
  }
}
```

### 3. No Shadow Module Implementation

**No changes** to `migrate_main.tf` or other shadow module locals. The `timeouts` block is NOT part of:
- `local.body`
- `local.sensitive_body`
- `local.azapi_header`
- `local.replace_triggers_external_values`

The `timeouts` block is a Terraform resource meta-argument handled directly in the parent module's `azapi_resource` block.

## Child Task Numbers Ready for Delegation

The following child tasks under the `timeouts` block are now ready for delegation:

- **Task #37:** `timeouts.create` - Update default value in variable (if different investigation needed)
- **Task #38:** `timeouts.read` - Update default value in variable
- **Task #39:** `timeouts.update` - Update default value in variable
- **Task #40:** `timeouts.delete` - Update default value in variable

**Note:** Since this is Task #36 (block structure skeleton), and all default values have already been set correctly in this task, the child tasks #37-40 will only need to verify the defaults are correct. No expand function check is needed for timeouts as it's a meta-argument, not a data structure.

## Hidden Fields Check

**Not Applicable:** The `timeouts` block is a Terraform provider meta-argument, not a resource property. There are no expand/flatten functions for timeouts in the provider source code. The timeout values are directly used by the SDK's polling/waiting mechanisms.

## Mapping

**N/A** - Meta-argument (not mapped to Azure API)

The timeouts block does not map to any Azure API property. It controls how long the Terraform provider waits for Azure API operations to complete.

## Special Handling

### Meta-Argument Pattern

The `timeouts` block follows a special pattern:
1. **Variable definition:** Contains all timeout fields with defaults
2. **Output:** Passes the variable value to parent module
3. **Parent module usage:** Configures `azapi_resource.timeouts` block directly

### No ForceNew Behavior

Changes to timeout values do **NOT** trigger resource replacement. Timeouts only affect operation wait durations, not the resource itself.

### No Azure API Validation

Timeout values are validated by Terraform's duration parser (e.g., "30m", "1h30m"). No Azure API validation is involved.

## Critical Review & Edge Case Analysis

### Null Semantics
- **Variable level:** `nullable = false` prevents null assignment
- **Field level:** Each field has `optional(string, "XXm")` providing defaults
- **Result:** Timeouts always have defined values, never null

### Boundary Conditions
- **Empty string:** Not allowed by Terraform's duration parser
- **Invalid format:** Terraform validates format (e.g., "30m", "1h", "90s")
- **Zero duration:** Technically valid but not practical for API operations
- **Very long duration:** No upper limit enforced by provider

### Idempotency
- Timeout changes don't affect resource state
- Multiple applies with same timeouts are idempotent
- Timeout values don't influence API request body

### Safe References
- The `var.timeouts` is guaranteed non-null due to `nullable = false`
- Individual fields have defaults via `optional(string, "XXm")`
- Direct field access is safe: `var.timeouts.create`

### Duration Format Conversion
- **Provider:** Uses Go's `time.Minute` (e.g., `30 * time.Minute`)
- **Terraform:** Uses string format (e.g., `"30m"`)
- **Conversion:** `30 * time.Minute` → `"30m"`, `5 * time.Minute` → `"5m"`

## Checklist

- ✅ Property in correct local: N/A (meta-argument)
- ✅ ForceNew wrapped: N/A (timeouts don't trigger replacement)
- ✅ ALL logic EXACTLY replicated from provider: Timeout defaults extracted from provider source code
- ✅ Validations IMPLEMENTED in variables.tf: N/A (Terraform validates duration format)
- ✅ TODO comment added to original field: N/A (no sensitive fields)
- ✅ Hidden fields checked: N/A (no expand function for meta-argument)
- ✅ Deferred work in following.md: None
- ✅ Deferred work from following.md: None
- ✅ Critical review: Completed (see Edge Case Analysis)
- ✅ Edge Case Analysis in proof: Completed above
- ✅ Proof created: This document
- ✅ `track.md` updated to Pending for check: Will update
- ✅ Self-Review: Only implemented timeouts block structure skeleton, no other fields added

---

## ✅ CHECKER VALIDATION - APPROVED

**Checked by:** Checker Agent
**Date:** 2026-01-06
**Task:** #36 - timeouts

### Validation Results

✅ **Meta-Argument Pattern:** Correctly implemented as pass-through via output, not in shadow module locals
✅ **Variable Definition:** All four timeout fields defined with correct defaults from provider source (30m, 30m, 5m, 30m)
✅ **Default Synchronization (CRITICAL):** `type` definition `optional(string, "XXm")` exactly matches `default` block values for all four fields
✅ **Nullable = false:** Explicitly set as required by `timeouts.md` special rules
✅ **Output:** `output "timeouts" { value = var.timeouts }` correctly added to `migrate_outputs.tf`
✅ **No Shadow Module Changes:** Correctly - no changes to `migrate_main.tf` locals (body, sensitive_body, etc.)
✅ **Provider Source Evidence:** Provider schema evidence with Go code properly documented
✅ **Descriptions:** All fields properly documented with correct default durations
✅ **Deferred Work:** No `following.md` file - no deferred work to complete
✅ **Scope Compliance:** Only implemented timeouts block structure skeleton, no unauthorized additions

### Compliance Statement

This implementation EXACTLY follows the special rules in `timeouts.md` and `executor.md`. The executor correctly recognized that `timeouts` is a Terraform provider meta-argument, not an Azure API property, and implemented it as a pass-through variable with output rather than in shadow module locals. All timeout defaults extracted from provider source code are correctly converted and synchronized between `type` and `default` definitions. The CRITICAL requirement of `nullable = false` is present.

**Status:** APPROVED ✅

---
