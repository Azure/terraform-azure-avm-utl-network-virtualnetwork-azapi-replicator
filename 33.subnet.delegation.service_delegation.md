# Task #33 - subnet.delegation.service_delegation - Block Structure Skeleton

## Summary
Created structure skeleton for the nested block `subnet.delegation.service_delegation` with comment placeholders for child arguments (Tasks #34-35). The service_delegation block is conditionally rendered when present in the delegation configuration and maps to the `properties` field in the Azure API delegation object.

## Create Phase Verification

### Query Create Method
```go
func resourceVirtualNetworkCreate(d *pluginsdk.ResourceData, meta interface{}) error {
    // ...
    vnetProperties, routeTables, err := expandVirtualNetworkProperties(ctx, *client, id, d)
    if err != nil {
        return err
    }
    // ...
    vnet := virtualnetworks.VirtualNetwork{
        Name:             pointer.To(id.VirtualNetworkName),
        ExtendedLocation: expandEdgeZoneModel(d.Get("edge_zone").(string)),
        Location:         pointer.To(location.Normalize(d.Get("location").(string))),
        Properties:       vnetProperties,
        Tags:             tags.Expand(d.Get("tags").(map[string]interface{})),
    }
    // ...
    if err := client.CreateOrUpdateThenPoll(ctx, id, vnet); err != nil {
        return fmt.Errorf("creating %s: %+v", id, err)
    }
    // ...
}
```

### Pattern Identification
**Single-phase operation**: The resource uses a single `CreateOrUpdateThenPoll` call. The service_delegation data is processed in `expandVirtualNetworkSubnetDelegation` before the primary create operation.

### Field Classification
The `service_delegation` block is part of the delegation configuration within subnet. The data flows through:
1. `expandVirtualNetworkProperties` → builds subnet properties
2. `expandVirtualNetworkSubnetDelegation` → builds delegation array, including service delegation properties
3. Assigned to delegation properties

**Decision**: Field belongs in `local.body` (Create phase, included in primary CreateOrUpdate operation).

## Assignment Path Verification

### Predicted Path
`body.properties.subnets[].properties.delegations[].properties`

### Go Code Evidence
From `expandVirtualNetworkSubnetDelegation`:
```go
func expandVirtualNetworkSubnetDelegation(input []interface{}) *[]virtualnetworks.Delegation {
    retDelegations := make([]virtualnetworks.Delegation, 0)

    for _, deleValue := range input {
        deleData := deleValue.(map[string]interface{})
        deleName := deleData["name"].(string)
        srvDelegations := deleData["service_delegation"].([]interface{})
        srvDelegation := srvDelegations[0].(map[string]interface{})
        srvName := srvDelegation["name"].(string)

        srvActions := srvDelegation["actions"].(*pluginsdk.Set).List()

        retSrvActions := make([]string, 0)
        for _, srvAction := range srvActions {
            srvActionData := srvAction.(string)
            retSrvActions = append(retSrvActions, srvActionData)
        }

        retDelegation := virtualnetworks.Delegation{
            Name: &deleName,
            Properties: &virtualnetworks.ServiceDelegationPropertiesFormat{
                ServiceName: &srvName,
                Actions:     &retSrvActions,
            },
        }

        retDelegations = append(retDelegations, retDelegation)
    }

    return &retDelegations
}
```

Assignment chain:
1. Extract service_delegation from Terraform config: `srvDelegations := deleData["service_delegation"].([]interface{})`
2. Take first element (MaxItems: 1): `srvDelegation := srvDelegations[0].(map[string]interface{})`
3. Extract fields: `srvName := srvDelegation["name"].(string)` and `srvActions := srvDelegation["actions"].(*pluginsdk.Set).List()`
4. Assign to Properties struct: `Properties: &virtualnetworks.ServiceDelegationPropertiesFormat{ ServiceName: &srvName, Actions: &retSrvActions }`
5. Assigned to Delegation struct properties
6. Return `*[]virtualnetworks.Delegation` from expand function
7. Called from `expandVirtualNetworkProperties`: `subnetObj.Properties.Delegations = expandVirtualNetworkSubnetDelegation(subnet["delegation"].([]interface{}))`
8. `subnetObj` is `virtualnetworks.Subnet`
9. Subnet added to `properties.Subnets` slice
10. `vnet.Properties = vnetProperties`
11. `vnet` becomes the request body

### Verified Path
`body.properties.subnets[].properties.delegations[].properties`

### Path Comparison
**MATCH** ✅ - Predicted path matches verified path. The Terraform `service_delegation` block maps to the API's `properties` field within each delegation object.

## Provider Schema

From `resourceVirtualNetworkSchema()`:
```go
"service_delegation": {
    Type:       pluginsdk.TypeList,
    Required:   true,
    MaxItems:   1,
    ConfigMode: pluginsdk.SchemaConfigModeAttr,
    Elem: &pluginsdk.Resource{
        Schema: map[string]*pluginsdk.Schema{
            "name": {
                Type:         pluginsdk.TypeString,
                Required:     true,
                ValidateFunc: validation.StringInSlice(subnetDelegationServiceNames, false),
            },

            "actions": {
                Type:     pluginsdk.TypeSet,
                Optional: true,
                Elem: &pluginsdk.Schema{
                    Type: pluginsdk.TypeString,
                    ValidateFunc: validation.StringInSlice([]string{
                        "Microsoft.Network/networkinterfaces/*",
                        "Microsoft.Network/publicIPAddresses/join/action",
                        "Microsoft.Network/publicIPAddresses/read",
                        "Microsoft.Network/virtualNetworks/read",
                        "Microsoft.Network/virtualNetworks/subnets/action",
                        "Microsoft.Network/virtualNetworks/subnets/join/action",
                        "Microsoft.Network/virtualNetworks/subnets/prepareNetworkPolicies/action",
                        "Microsoft.Network/virtualNetworks/subnets/unprepareNetworkPolicies/action",
                    }, false),
                },
            },
        },
    },
},
```

**Key Properties:**
- **Type**: List (TypeList) with MaxItems: 1
- **Required**: true (within delegation block)
- **ConfigMode**: SchemaConfigModeAttr
- **Child fields**: 
  - `name` (Required, String with validation - enum of service names)
  - `actions` (Optional, Set of Strings with validation)

## Azure API Schema

From the API schema, the delegation structure is:
```
delegations: List(ObjectWithOptionalAttrs(map[string]Type{
    "id":String, 
    "name":String, 
    "properties":ObjectWithOptionalAttrs(map[string]Type{
        "serviceName":String,
        "actions":List(String)
    }, []string{"serviceName"}), 
    "type":String
}, []string{"id", "name", "properties", "type"}))
```

**API Structure:**
- `properties` field contains the service delegation configuration
- `properties.serviceName` - the service name (maps from `service_delegation.name`)
- `properties.actions` - optional list of actions (maps from `service_delegation.actions`)

## Hidden Fields

### Detection Process
Checked `expandVirtualNetworkSubnetDelegation` function for any hardcoded values or fields not in the Terraform schema that belong to the service_delegation properties.

### Analysis
```go
retDelegation := virtualnetworks.Delegation{
    Name: &deleName,
    Properties: &virtualnetworks.ServiceDelegationPropertiesFormat{
        ServiceName: &srvName,
        Actions:     &retSrvActions,
    },
}
```

**Findings:**
- ✅ `Properties.ServiceName` - mapped from `service_delegation.name` (Task #34)
- ✅ `Properties.Actions` - mapped from `service_delegation.actions` (Task #35)
- ⚠️ No additional fields in the Properties struct beyond ServiceName and Actions

**Conclusion:** NO hidden fields to add. All fields in the ServiceDelegationPropertiesFormat struct are explicitly mapped from the Terraform configuration.

## Mapping

| Terraform (snake_case) | Azure API (camelCase) | Notes |
|------------------------|----------------------|-------|
| `service_delegation` | `delegations[].properties` | Block maps to properties object |
| `service_delegation.name` | `delegations[].properties.serviceName` | Task #34 |
| `service_delegation.actions` | `delegations[].properties.actions` | Task #35 (Optional) |

## Special Handling

### Structure Type
**Block skeleton** - This is a Type 3 task. Creating only the conditional structure with comment placeholders for child arguments.

### Conditional Rendering
The service_delegation block is:
1. Required within each delegation block (when delegation exists)
2. A list with MaxItems: 1 in Terraform
3. The provider extracts the first element: `srvDelegation := srvDelegations[0].(map[string]interface{})`
4. Maps to a properties object in the API (not an array)

The skeleton conditionally includes properties only when service_delegation is present in the delegation configuration.

### Implementation Pattern
Since `ignore_null_property = true` is set, we can directly assign `null` when service_delegation is not present (though it's Required, so this is primarily for safety). The skeleton uses a conditional expression to check for presence and handle the list-to-object conversion.

**CRITICAL**: The provider accesses the first element directly: `srvDelegations[0]`. This is safe because:
- Terraform schema enforces MaxItems: 1
- Terraform schema marks it as Required: true (within delegation block)
- However, we add defensive null checks for robustness

## Shadow Implementation

```hcl
locals {
  body = {
    properties = {
      subnets = (var.subnet != null && length(var.subnet) > 0) ? [
        for subnet in var.subnet : {
          name = subnet.name
          properties = merge(
            # ... existing fields ...
            {
              delegations = subnet.delegation != null && length(subnet.delegation) > 0 ? [
                for delegation in subnet.delegation : {
                  name = delegation.name
                  properties = delegation.service_delegation != null && length(delegation.service_delegation) > 0 ? {  # <-
                    serviceName = null # Task #34                                                                      # <-
                    actions     = null # Task #35                                                                      # <-
                  } : null                                                                                             # <-
                }
              ] : null
            }
          )
        }
      ] : null
    }
  }
}
```

## Child Tasks Ready for Delegation

Based on the schema analysis, the following child tasks are now ready to be implemented:

| Task # | Field Path | Type | Required | Notes |
|--------|-----------|------|----------|-------|
| 34 | subnet.delegation.service_delegation.name | Argument | Yes | Service name with validation (enum of valid service names) |
| 35 | subnet.delegation.service_delegation.actions | Argument | No | Optional set of delegation actions with validation (enum) |

**Implementation Note**: Since `service_delegation` is a list with MaxItems: 1 in Terraform but maps to a single object in the API, the child task implementations will need to extract from the first element when present.

## Deferred Work Completion

Checked `following.md` - file does not exist. No deferred work for this task.

## Critical Review & Edge Cases

### Null Semantics
- **Required block**: In provider schema, `service_delegation` is Required: true within the delegation block
- **Parent blocks**: Both delegation and subnet are optional
- **When delegation exists**: The service_delegation must be provided (enforced by Terraform's Required validation)
- **Conditional check**: Added defensive check `delegation.service_delegation != null && length(delegation.service_delegation) > 0` for robustness, even though Terraform enforces Required: true
- **Null result**: If service_delegation is somehow null/empty, properties is set to null (ignored by API with `ignore_null_property = true`)

### Edge Cases
1. **Empty list**: Provider schema enforces Required: true and MaxItems: 1, so empty list should not occur
2. **MaxItems: 1 enforcement**: Terraform schema enforces this - list will have exactly one element when present
3. **List-to-object mapping**: The expand function takes `srvDelegations[0]` to extract the single element and map it to the properties object
4. **Null properties**: With `ignore_null_property = true`, if properties is null, it's omitted from the API request
5. **Missing fields in properties**: Child tasks (#34, #35) will handle individual field presence; currently using null placeholders

### Safe References
- ✅ Check `delegation.service_delegation != null` before accessing
- ✅ Check `length(delegation.service_delegation) > 0` before extracting
- ✅ Safe to access within conditional when checks pass
- ✅ Individual field null checks will be handled by child tasks (#34, #35)

### Boundary Conditions
- **No service_delegation**: Properties field is null (though Required: true should prevent this)
- **One service_delegation**: Creates properties object with fields from that element (expected case)
- **Multiple service_delegations**: Not possible due to MaxItems: 1 in schema
- **service_delegation with null name**: Would fail Terraform validation (Required: true)
- **service_delegation with null actions**: Valid - actions is Optional (Task #35 will handle)

### Idempotency
- **Object structure**: Service delegation maps to a properties object (not array)
- **Stable fields**: serviceName and actions are stable fields within properties
- **No ordering concerns**: Not an array, so no ordering issues

## Checklist

- ✅ Skeleton structure created with comment placeholders
- ✅ Conditional rendering based on service_delegation presence
- ✅ Proper nesting: `properties.subnets[].properties.delegations[].properties`
- ✅ Hidden fields checked - none found (all fields from schema)
- ✅ Child tasks identified and documented (Tasks #34, #35)
- ✅ ForceNew not applicable (block skeleton only)
- ✅ Sensitive fields not applicable
- ✅ Validations not applicable (block skeleton only - child tasks will handle field validations)
- ✅ Critical review completed
- ✅ Edge case analysis included
- ✅ Proof document created
- ✅ Self-Review: Implementation adds ONLY the service_delegation block skeleton as required by Task #33
- ⏳ track.md to be updated to "Pending for check"

---

## ✅ CHECKER VALIDATION - APPROVED

**Checked by:** Checker Agent
**Date:** 2026-01-06
**Task:** #33 - subnet.delegation.service_delegation

### Validation Results

✅ **Block Skeleton Structure:** Correct skeleton-only implementation with comment placeholders for child tasks (#34, #35). No premature field implementations.

✅ **Conditional Rendering:** Proper defensive checks (`delegation.service_delegation != null && length(delegation.service_delegation) > 0`) before accessing the list, even though Required: true in schema. Matches executor.md guidance for safe references.

✅ **Assignment Path:** Verified path `body.properties.subnets[].properties.delegations[].properties` matches Azure API schema. The Terraform `service_delegation` list (MaxItems: 1) correctly maps to API's properties object.

✅ **Null Handling:** Correctly uses `null` when service_delegation is not present, which works properly with `ignore_null_property = true` in azapi_header.

✅ **Type Conversion:** Proper List (MaxItems: 1) to Object mapping pattern - checks presence and length before processing, matching provider's `srvDelegations[0]` extraction pattern.

✅ **Hidden Fields:** Correctly identified NO hidden fields exist. The ServiceDelegationPropertiesFormat struct contains only serviceName and actions, both from Terraform schema.

✅ **Schema Compliance:** Implementation matches provider schema exactly:
- service_delegation is Required: true within delegation block
- List with MaxItems: 1 (enforced by Terraform)
- Contains two child fields: name (Task #34) and actions (Task #35)

✅ **Create Phase:** Correctly placed in `local.body` (Create phase, single-phase operation with primary CreateOrUpdateThenPoll).

✅ **Proof Document Quality:** Complete with Go code evidence, assignment path tracing, schema analysis, edge case review, and critical analysis. No forbidden phrases or deviations from exact replication.

✅ **Deferred Work Completion:** No deferred work exists (following.md does not exist).

✅ **Edge Cases:** Properly analyzed null semantics, MaxItems: 1 enforcement, list-to-object mapping, and boundary conditions.

✅ **Task Scope:** Implementation adds ONLY the service_delegation block skeleton as required. No scope creep - child field implementations correctly deferred to Tasks #34 and #35.

### Compliance Statement

This implementation EXACTLY follows executor.md rules for Type 3 (Block Structure Skeleton) tasks. The skeleton provides proper structure with comment placeholders, correct conditional rendering, and accurate Azure API path mapping. No deviations, simplifications, or premature implementations were found.

**Status:** APPROVED ✅
