# Task #8: flow_timeout_in_minutes

## Summary
Implemented the `flow_timeout_in_minutes` root-level argument. This field sets the flow timeout in minutes for the Virtual Network (used for connection tracking for intra-VM flows), with validation requiring values between 4 and 30 minutes. The field is optional and directly assigned to `properties.flowTimeoutInMinutes` in the request body.

## Shadow Implementation

```hcl
# In variables.tf
variable "flow_timeout_in_minutes" {
  type        = number
  default     = null
  description = "(Optional) The flow timeout in minutes for the Virtual Network, which is used to enable connection tracking for intra-VM flows. Possible values are between `4` and `30` minutes."
  
  validation {
    condition     = var.flow_timeout_in_minutes == null || (var.flow_timeout_in_minutes >= 4 && var.flow_timeout_in_minutes <= 30)  # <-
    error_message = "The flow_timeout_in_minutes must be between 4 and 30 minutes."  # <-
  }
}

# In migrate_main.tf
locals {
  body = { 
    properties = {
      flowTimeoutInMinutes = var.flow_timeout_in_minutes  # <-
    }
  }
}
```

## Create Phase Verification

**Query Method**: `query_terraform_block_implementation_source_code` with `entrypoint_name=create`

**Pattern**: Single-phase (one `CreateOrUpdate` operation)

**Go Code Evidence**:
```go
func resourceVirtualNetworkCreate(d *pluginsdk.ResourceData, meta interface{}) error {
    // ... setup code ...
    
    vnetProperties, routeTables, err := expandVirtualNetworkProperties(ctx, *client, id, d)
    if err != nil {
        return err
    }

    vnet := virtualnetworks.VirtualNetwork{
        Name:             pointer.To(id.VirtualNetworkName),
        ExtendedLocation: expandEdgeZoneModel(d.Get("edge_zone").(string)),
        Location:         pointer.To(location.Normalize(d.Get("location").(string))),
        Properties:       vnetProperties,
        Tags:             tags.Expand(d.Get("tags").(map[string]interface{})),
    }

    if v, ok := d.GetOk("flow_timeout_in_minutes"); ok {
        vnet.Properties.FlowTimeoutInMinutes = pointer.To(int64(v.(int)))
    }
    
    // ... locks and other code ...
    
    if err := client.CreateOrUpdateThenPoll(ctx, id, vnet); err != nil {
        return fmt.Errorf("creating %s: %+v", id, err)
    }
    
    // ... waiting for provisioning state ...
    
    return resourceVirtualNetworkRead(d, meta)
}
```

**Classification**: The field is set directly on `vnet.Properties.FlowTimeoutInMinutes` BEFORE the primary `CreateOrUpdateThenPoll` call, so this is part of the **Create phase** (primary resource creation).

**Decision**: Add to `local.body.properties.flowTimeoutInMinutes`

## Assignment Path Verification

**Predicted Path**: `properties.flowTimeoutInMinutes`

**Go Code Evidence**:
```go
// In Create method
vnet := virtualnetworks.VirtualNetwork{
    Properties: vnetProperties,  // ← Properties struct created
}

if v, ok := d.GetOk("flow_timeout_in_minutes"); ok {
    vnet.Properties.FlowTimeoutInMinutes = pointer.To(int64(v.(int)))  // ← Direct assignment to Properties field
}
```

**Traced Assignments**:
1. `vnet := virtualnetworks.VirtualNetwork{}` - Creates VirtualNetwork struct
2. `vnet.Properties = vnetProperties` - Assigns Properties (type: VirtualNetworkPropertiesFormat pointer)
3. `vnet.Properties.FlowTimeoutInMinutes = pointer.To(int64(v.(int)))` - Direct assignment to Properties.FlowTimeoutInMinutes field

**Verified Path**: `properties.flowTimeoutInMinutes`

**Comparison**: ✅ Match - The predicted path matches the verified path.

## Provider Schema

**Source**: `resourceVirtualNetworkSchema()` in `github.com/hashicorp/terraform-provider-azurerm/internal/services/network`

```go
"flow_timeout_in_minutes": {
    Type:         pluginsdk.TypeInt,
    Optional:     true,
    ValidateFunc: validation.IntBetween(4, 30),
},
```

**Key Attributes**:
- Type: `TypeInt`
- Required: `false` (Optional: true)
- ForceNew: `false` (not set)
- ValidateFunc: `validation.IntBetween(4, 30)` - validates value is between 4 and 30 inclusive
- DiffSuppressFunc: None
- Default: None (implicit nil/null when not set)

## Azure API Schema

**Resource Type**: `Microsoft.Network/virtualNetworks@2024-07-01`

**Property Path**: `properties.flowTimeoutInMinutes`

**Schema Type**: `Number`

**Documentation**: "The FlowTimeout value (in minutes) for the Virtual Network"

**Field Characteristics**:
- Not marked as Required
- Not marked as ReadOnly
- Type: Number (integer)

## Hidden Fields

None. The field is explicitly defined in the schema and directly corresponds to user input.

## Mapping

**Terraform (snake_case)** → **Azure API (camelCase)**:
- `flow_timeout_in_minutes` → `flowTimeoutInMinutes`

## Special Handling

### 1. Validation

**Provider Validation**: `validation.IntBetween(4, 30)`

**Implementation**: Added validation block in `variables.tf`:
```hcl
validation {
  condition     = var.flow_timeout_in_minutes == null || (var.flow_timeout_in_minutes >= 4 && var.flow_timeout_in_minutes <= 30)
  error_message = "The flow_timeout_in_minutes must be between 4 and 30 minutes."
}
```

**Rationale**: Replicates exact provider validation to ensure users get immediate feedback at plan time rather than during API calls.

### 2. Update Behavior

**Go Code Evidence**:
```go
func resourceVirtualNetworkUpdate(d *pluginsdk.ResourceData, meta interface{}) error {
    // ... setup code ...
    
    payload := existing.Model

    if d.HasChange("flow_timeout_in_minutes") {
        payload.Properties.FlowTimeoutInMinutes = nil
        if v := d.Get("flow_timeout_in_minutes"); v.(int) != 0 {
            payload.Properties.FlowTimeoutInMinutes = pointer.To(int64(v.(int)))
        }
    }
    
    // ... other changes ...
    
    if err := client.CreateOrUpdateThenPoll(ctx, *id, *payload); err != nil {
        return fmt.Errorf("updating %s: %+v", id, err)
    }
    
    // ...
}
```

**Analysis**: 
- The Update method first nils out the field
- Then only sets it if the value is not 0
- This means when the user removes the field or sets it to 0, it sends `null` to the API
- When a positive value (4-30) is set, it sends that value

**Implementation**: Direct assignment `flowTimeoutInMinutes = var.flow_timeout_in_minutes` is correct because:
1. With `ignore_null_property = true`, null values are automatically omitted from the request
2. When var is null (not set), the field won't be sent
3. When var has a value (4-30), it will be sent as-is
4. The provider never sends 0 (it nils out the field if 0), and our validation ensures only 4-30 or null are valid

### 3. ForceNew

**Schema**: `ForceNew: false` (not set, so updates are allowed)

**CustomizeDiff**: None (checked in `resourceVirtualNetwork()` - no CustomizeDiff defined)

**Conclusion**: No ForceNew behavior. Field can be updated in place. No entry needed in `replace_triggers_external_values`.

### 4. Nullable Behavior

**Direct Assignment Rationale**:
- Field is optional with no default
- `ignore_null_property = true` is set in azapi_header
- When null, Azure API will use its default behavior (no flow timeout configured)
- Direct assignment: `flowTimeoutInMinutes = var.flow_timeout_in_minutes` automatically handles null correctly

## Deferred Work Completion

**Checked**: `following.md` does not exist. No work was deferred to this task.

## Critical Review & Edge Case Analysis

### Null Semantics
- **Null meaning**: "Do not configure flow timeout" - Azure API will not apply any flow timeout settings
- **Implementation**: Direct assignment with `ignore_null_property = true` correctly handles this
- **Provider behavior match**: ✅ Provider nils out the field when value is 0 or not set

### Boundary Conditions
- **Minimum value (4)**: Validated in variables.tf - user will get error if they try to set < 4
- **Maximum value (30)**: Validated in variables.tf - user will get error if they try to set > 30
- **Zero value**: Not allowed by validation (minimum is 4) - matches provider which treats 0 as "unset"
- **Negative values**: Not allowed by validation (minimum is 4)
- **Non-integer values**: Terraform type system enforces `number` type

### Type Considerations
- **Provider type**: `int64` via `pointer.To(int64(v.(int)))`
- **Terraform type**: `number` (can represent integers)
- **Azure API type**: `Number` (JSON number)
- **Conversion**: Direct assignment works because Terraform's number type maps to JSON number

### Idempotency
- ✅ Single value (not a collection), no ordering issues
- ✅ Null handling is consistent across plans
- ✅ With `ignore_null_property = true`, absence of field in state won't cause spurious diffs

### Safe References
- ✅ Direct variable reference `var.flow_timeout_in_minutes` - no nested access, always safe
- ✅ No complex transformations or dependent values

### Update Logic Analysis
The provider's Update method has specific handling:
```go
if d.HasChange("flow_timeout_in_minutes") {
    payload.Properties.FlowTimeoutInMinutes = nil
    if v := d.Get("flow_timeout_in_minutes"); v.(int) != 0 {
        payload.Properties.FlowTimeoutInMinutes = pointer.To(int64(v.(int)))
    }
}
```

This means:
1. If user removes the field → sends null (removes timeout)
2. If user sets to valid value (4-30) → sends that value
3. If somehow 0 gets through (shouldn't due to validation) → sends null

Our implementation with direct assignment + validation exactly replicates this:
- Validation prevents 0 or invalid values
- Direct assignment with `ignore_null_property = true` omits null from request body
- Non-null valid values (4-30) are sent as-is

## Checklist

- ✅ Property in correct local (`local.body.properties.flowTimeoutInMinutes`)
- ✅ Validation IMPLEMENTED in variables.tf (IntBetween 4 and 30)
- ✅ No ForceNew (field is updatable)
- ✅ No hidden fields
- ✅ No deferred work (following.md doesn't exist)
- ✅ No work deferred FROM this task
- ✅ Critical review completed (null semantics, boundaries, idempotency, safe refs)
- ✅ Edge Case Analysis included
- ✅ Proof document created
- ✅ Implementation exactly matches provider behavior
- ✅ Self-Review: Only added flow_timeout_in_minutes field, no other fields added

---

## ✅ CHECKER VALIDATION - APPROVED

**Checked by:** Checker Agent
**Date:** 2026-01-06
**Task:** #8 - flow_timeout_in_minutes

### Validation Results

✅ **ForceNew Logic:** No ForceNew behavior (field is updatable in place). Correctly excluded from `replace_triggers_external_values`.

✅ **Stable Keys:** Not applicable (no ForceNew entries).

✅ **Phase Detection:** Field correctly placed in `local.body.properties` (Create phase - assigned before primary CreateOrUpdateThenPoll).

✅ **Type Conversion:** Correct conversion from Terraform `number` to Azure API `Number` (JSON number). Direct assignment works correctly.

✅ **Null Handling:** Correctly propagates null semantics with `ignore_null_property = true`. When null, field is omitted from API request (no flow timeout configured).

✅ **Validations:** Provider validation `validation.IntBetween(4, 30)` exactly replicated in `variables.tf` validation block. Error message is clear and appropriate.

✅ **Deferred Work Completion:** No deferred work for this task (following.md doesn't exist).

✅ **Deferred Work Recording:** No deferrals made by this task.

✅ **Edge Cases:** Comprehensive edge case analysis provided. Null semantics, boundary conditions (4-30), type considerations, idempotency, and update logic all properly analyzed and handled.

✅ **Assignment Path:** Correctly traced through Go code. Path `properties.flowTimeoutInMinutes` verified with struct assignment evidence.

✅ **Naming Convention:** Correct camelCase conversion: `flow_timeout_in_minutes` → `flowTimeoutInMinutes`.

✅ **Update Behavior:** Update method analysis shows proper null handling. Provider nils out field when 0 or not set; implementation replicates this exactly with validation preventing invalid values and direct assignment with `ignore_null_property = true`.

### Compliance Statement

This implementation EXACTLY replicates the provider behavior as required by `executor.md`. No deviations, simplifications, or "safer alternatives" were found. The validation is implemented at plan time (not deferred to API), the field is correctly placed in Create phase body, null handling matches provider semantics, and type conversion is appropriate.

**Status:** APPROVED ✅

---
