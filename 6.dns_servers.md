# Task #6 - dns_servers - Root-Level Argument

## Shadow Implementation

```hcl
# In migrate_main.tf
locals {
  body = { 
    properties = {
      dhcpOptions = {
        dnsServers = var.dns_servers  # <-
      }
    }
  }
}
```

## Summary

The `dns_servers` field is an optional, computed list of DNS server IP addresses that maps to `properties.dhcpOptions.dnsServers` in the Azure API. It supports updates and has validation requiring non-empty strings.

## Create Phase Verification

**Pattern:** Single-phase creation (one `CreateOrUpdateThenPoll` operation)

**Evidence from Create method:**
```go
func resourceVirtualNetworkCreate(d *pluginsdk.ResourceData, meta interface{}) error {
	// ...
	vnetProperties, routeTables, err := expandVirtualNetworkProperties(ctx, *client, id, d)
	// ...
	vnet := virtualnetworks.VirtualNetwork{
		Name:             pointer.To(id.VirtualNetworkName),
		ExtendedLocation: expandEdgeZoneModel(d.Get("edge_zone").(string)),
		Location:         pointer.To(location.Normalize(d.Get("location").(string))),
		Properties:       vnetProperties,  // Properties includes dns_servers
		Tags:             tags.Expand(d.Get("tags").(map[string]interface{})),
	}
	// ...
	if err := client.CreateOrUpdateThenPoll(ctx, id, vnet); err != nil {
		return fmt.Errorf("creating %s: %+v", id, err)
	}
	// ...
}
```

**Decision:** The `dns_servers` field is set during the primary `CreateOrUpdateThenPoll` operation via `expandVirtualNetworkProperties`. It belongs in `local.body`.

## Assignment Path Verification

**Predicted Path:** `properties.dhcpOptions.dnsServers`

**Evidence from expandVirtualNetworkProperties:**
```go
func expandVirtualNetworkProperties(ctx context.Context, client virtualnetworks.VirtualNetworksClient, id commonids.VirtualNetworkId, d *pluginsdk.ResourceData) (*virtualnetworks.VirtualNetworkPropertiesFormat, *[]string, error) {
	// ...
	properties := &virtualnetworks.VirtualNetworkPropertiesFormat{
		AddressSpace: &virtualnetworks.AddressSpace{},
		DhcpOptions: &virtualnetworks.DhcpOptions{
			DnsServers: utils.ExpandStringSlice(d.Get("dns_servers").([]interface{})),
		},
		// ...
	}
	// ...
	return properties, &routeTables, nil
}
```

The properties object is assigned to `vnet.Properties` in the Create method:
```go
vnet := virtualnetworks.VirtualNetwork{
	// ...
	Properties:       vnetProperties,
	// ...
}
```

**Verified Path:** `properties.dhcpOptions.dnsServers` ✅

**Path Comparison:** Predicted path matches verified path.

## Provider Schema

```go
"dns_servers": {
	Type:     pluginsdk.TypeList,
	Optional: true,
	Computed: true,
	Elem: &pluginsdk.Schema{
		Type:         pluginsdk.TypeString,
		ValidateFunc: validation.StringIsNotEmpty,
	},
},
```

**Key Properties:**
- **Type:** List of strings
- **Optional:** true
- **Computed:** true (Azure returns default DNS servers if not specified)
- **ForceNew:** false (not present)
- **Validation:** Each DNS server string must not be empty
- **DiffSuppressFunc:** None

## Azure API Schema

**Resource Type:** `Microsoft.Network/virtualNetworks@2024-07-01`

**Path:** `body.properties.dhcpOptions.dnsServers`

**Type:** List(String)

**Description from Azure API:** "The list of DNS servers IP addresses."

**Required:** No (optional field)

**Read-Only:** No

**Write-Only:** No

## Hidden Fields

None. The `dhcpOptions` object only contains `dnsServers` according to the Azure API schema.

## Mapping

| Terraform (snake_case) | Azure API (camelCase) |
|------------------------|----------------------|
| dns_servers | dnsServers |

**Parent Object:** dhcpOptions

## Special Handling

### Validation (MANDATORY)

**Value Constraint - Non-Empty Strings:**

The provider schema shows:
```go
Elem: &pluginsdk.Schema{
	Type:         pluginsdk.TypeString,
	ValidateFunc: validation.StringIsNotEmpty,
}
```

**Implementation in variables.tf:**

Already exists in `variables.tf` at lines 91-95:
```hcl
variable "dns_servers" {
  type        = list(string)
  default     = null
  description = "(Optional) List of IP addresses of DNS servers"
}
```

**Additional validation needed:**
```hcl
variable "dns_servers" {
  type        = list(string)
  default     = null
  description = "(Optional) List of IP addresses of DNS servers"
  
  validation {
    condition = var.dns_servers == null || alltrue([
      for dns in var.dns_servers : length(dns) > 0
    ])
    error_message = "Each DNS server address must not be empty."
  }
}
```

### ForceNew

**Schema Check:** `ForceNew: true` is NOT present in the schema.

**CustomizeDiff Check:** No `CustomizeDiff` function is defined for `azurerm_virtual_network` resource (verified in resource function).

**Update Method Check:**
```go
func resourceVirtualNetworkUpdate(d *pluginsdk.ResourceData, meta interface{}) error {
	// ...
	if d.HasChange("dns_servers") {
		if payload.Properties.DhcpOptions == nil {
			payload.Properties.DhcpOptions = &virtualnetworks.DhcpOptions{}
		}

		payload.Properties.DhcpOptions.DnsServers = utils.ExpandStringSlice(d.Get("dns_servers").([]interface{}))
	}
	// ...
	if err := client.CreateOrUpdateThenPoll(ctx, *id, *payload); err != nil {
		return fmt.Errorf("updating %s: %+v", id, err)
	}
	// ...
}
```

**Decision:** The `dns_servers` field is updateable and does NOT trigger ForceNew. No entry needed in `replace_triggers_external_values`.

### Computed Behavior

The field is marked as `Computed: true` in the schema, meaning:
- When `dns_servers` is null or not provided, Azure may return default DNS servers
- The flatten function handles this:
```go
func flattenVirtualNetworkDNSServers(input *virtualnetworks.DhcpOptions) []string {
	results := make([]string, 0)

	if input != nil {
		if servers := input.DnsServers; servers != nil {
			results = *servers
		}
	}

	return results
}
```

In our implementation, we can safely pass `null` to the API when the user doesn't specify `dns_servers`, and Azure will handle the default behavior. With `ignore_null_property = true`, the null value will be omitted from the request.

### Sensitive Fields

The `dns_servers` field is NOT marked as `Sensitive: true` and is NOT a WriteOnly field. No special handling needed.

## Deferred Work Completion

Checked `following.md` - file does not exist. No deferred work to complete.

## Critical Review & Edge Case

### Null Semantics
- **`null`:** Means user did not specify DNS servers. Azure will use its default DNS configuration. With `ignore_null_property = true`, the field is omitted from the request.
- **Empty list `[]`:** Means user explicitly wants no custom DNS servers. This is a valid configuration - Azure will remove custom DNS servers and revert to default Azure DNS.

### Edge Cases
1. **Empty string in list:** Validation prevents this (`StringIsNotEmpty`)
2. **Null value in list elements:** Terraform's type system prevents this (list(string) does not allow null elements)
3. **Empty list vs null:** Both are valid - empty list explicitly removes DNS servers, null omits the field

### Idempotency
The implementation is idempotent:
- List ordering matters for DNS servers (primary, secondary, etc.)
- Terraform's list type preserves order
- Direct assignment ensures consistent API representation

### Safe References
- Direct assignment of `var.dns_servers` (can be null)
- No nested property access that could fail
- Parent object `dhcpOptions` will be created automatically by the API structure

## Checklist

- ✅ Property in correct local (`body.properties.dhcpOptions.dnsServers`)
- ✅ ForceNew not needed (field is updateable)
- ✅ All logic exactly replicated from provider (no shortcuts)
- ✅ Validations implemented in variables.tf (non-empty string validation)
- ✅ Hidden fields checked (none found)
- ✅ Deferred work checked (none found)
- ✅ Critical review completed (null semantics, edge cases, idempotency, safe references)
- ✅ Edge Case Analysis included
- ✅ Proof created
- ✅ Ready for track.md update

## Implementation Summary

The `dns_servers` field is a straightforward optional list that maps directly to `properties.dhcpOptions.dnsServers`. It supports updates, has validation for non-empty strings, and handles null values gracefully. With `ignore_null_property = true`, null values are automatically omitted from the API request, allowing Azure to apply its default DNS configuration.

---

## ✅ CHECKER VALIDATION - APPROVED

**Checked by:** Checker Agent
**Date:** 2026-01-06
**Task:** #6 - dns_servers

### Validation Results

✅ **ForceNew Logic:** Not required - field is updateable (Update method shows `HasChange("dns_servers")` handling)
✅ **Stable Keys:** N/A - no ForceNew triggers needed
✅ **Phase Detection:** Field correctly placed in `local.body` (set during Create phase via `expandVirtualNetworkProperties`)
✅ **Type Conversion:** Correct - `list(string)` maps directly to Azure API `List(String)`
✅ **Null Handling:** Correctly uses direct assignment with `ignore_null_property = true`
✅ **Validations:** Provider validation replicated exactly in `variables.tf` (`StringIsNotEmpty` → validation block with `length(dns) > 0`)
✅ **Deferred Work Completion:** No deferred work for this task (following.md does not exist)
✅ **Deferred Work Recording:** No deferrals made by this task
✅ **Edge Cases:** All edge cases properly analyzed - null vs empty list semantics, validation prevents empty strings, idempotent list handling

### Compliance Statement

This implementation EXACTLY replicates the provider behavior as required by `executor.md`. The validation correctly translates `StringIsNotEmpty` to a Terraform validation block. Direct assignment approach is appropriate given `ignore_null_property = true`. Assignment path verification with Go code evidence confirms correct nesting under `dhcpOptions`. No deviations, simplifications, or "safer alternatives" were found.

**Status:** APPROVED ✅

---
