# Task #10: tags - Proof Document

## Shadow Implementation

The `tags` field is already correctly implemented in `migrate_main.tf`:

```hcl
locals {
  azapi_header = {
    type                  = "Microsoft.Network/virtualNetworks@2024-07-01"
    name                  = var.name
    location              = local.normalized_location
    parent_id             = var.resource_group_id
    tags                  = var.tags  # <-
    ignore_null_property  = true
    retry                 = null
  }
}
```

## Summary

The `tags` argument is an optional `map(string)` field that allows users to assign metadata tags to the virtual network resource. Tags are root-level in both Azure API and azapi_resource, correctly placed in `azapi_header.tags`. No ForceNew behavior - tags can be updated in place.

## Create Phase Verification

**Query Create Method:**

```go
func resourceVirtualNetworkCreate(d *pluginsdk.ResourceData, meta interface{}) error {
	// ... setup code ...
	
	vnet := virtualnetworks.VirtualNetwork{
		Name:             pointer.To(id.VirtualNetworkName),
		ExtendedLocation: expandEdgeZoneModel(d.Get("edge_zone").(string)),
		Location:         pointer.To(location.Normalize(d.Get("location").(string))),
		Properties:       vnetProperties,
		Tags:             tags.Expand(d.Get("tags").(map[string]interface{})),  // <- Direct assignment during create
	}
	
	// ... more setup ...
	
	if err := client.CreateOrUpdateThenPoll(ctx, id, vnet); err != nil {
		return fmt.Errorf("creating %s: %+v", id, err)
	}
	
	// ... wait for provisioning state ...
	
	return resourceVirtualNetworkRead(d, meta)
}
```

**Pattern Identification:** Single-phase creation pattern. The resource uses a single `CreateOrUpdateThenPoll` call without any subsequent operations.

**Field Classification:** The `tags` field is assigned to the VirtualNetwork struct before the primary `CreateOrUpdateThenPoll` call, making it a **Create phase field**.

**Decision:** Place `tags` in `local.azapi_header` (root level of azapi_resource).

## Assignment Path Verification

**Predicted Path:** `tags` (root level)

**Go Code Evidence:**

```go
vnet := virtualnetworks.VirtualNetwork{
	Name:             pointer.To(id.VirtualNetworkName),
	ExtendedLocation: expandEdgeZoneModel(d.Get("edge_zone").(string)),
	Location:         pointer.To(location.Normalize(d.Get("location").(string))),
	Properties:       vnetProperties,
	Tags:             tags.Expand(d.Get("tags").(map[string]interface{})),  // <- Assigned to vnet.Tags
}
```

The struct assignment shows `Tags` is a direct field on the `VirtualNetwork` struct at the root level, not nested inside `Properties`.

**Verified Path:** `tags` (root level in Azure API)

**Path Comparison:** ✅ Match - The predicted path matches the actual assignment path. Tags is a root-level field in the Azure Virtual Network resource.

## Provider Schema

**Source:** `query_terraform_schema` output for `azurerm_virtual_network.tags`

```json
{
  "type": ["map", "string"],
  "description_kind": "plain",
  "optional": true
}
```

**Key Attributes:**
- **Type:** `map(string)` - A mapping of string keys to string values
- **Optional:** Yes
- **Default:** None (implicitly null when not specified)
- **ForceNew:** No - Tags can be updated without recreation

## Azure API Schema

**Resource Type:** `Microsoft.Network/virtualNetworks@2024-07-01`

**Property Path:** `tags` (root level, not in `properties`)

**Schema Type:** `Map(String)`

**Description:** "A mapping of tags which should be assigned to the Azure resource."

**Verification:** Azure API confirms `tags` is a root-level field alongside `location`, `name`, `type`, `id`, and `properties`.

## Hidden Fields

None. The `tags` field has no hidden values or implicit defaults set by the provider.

## Mapping

**AzureRM Provider:**
- Field name: `tags`
- Type: `map[string]interface{}`
- Location: Root-level argument

**Azure API:**
- Field name: `tags`
- Type: `Map(String)`
- Location: Root level (not in properties)

**Naming Conversion:** None needed - `tags` remains `tags` (no snake_case to camelCase conversion required for this field).

## Special Handling

### Not ForceNew

Tags do NOT have `ForceNew: true` in the schema. Changes to tags trigger an in-place update through the Update method:

```go
func resourceVirtualNetworkUpdate(d *pluginsdk.ResourceData, meta interface{}) error {
	// ... setup code ...
	
	if d.HasChange("tags") {
		payload.Tags = tags.Expand(d.Get("tags").(map[string]interface{}))  // <- In-place update
	}
	
	// ... apply update via CreateOrUpdateThenPoll ...
}
```

**Implementation:** Since `tags` is NOT ForceNew, it should NOT be added to `replace_triggers_external_values`. Tags are updatable in place.

### Root-Level Placement

Per executor.md instructions, `tags` is one of the special fields that goes in `azapi_header` at the root level of `azapi_resource`, NOT in the `body`:

> "In `azapi_resource`: ONLY `type`, `location`, `name`, `parent_id`, `identity`, `tags` go to root; ALL other fields (including root-level API fields like `zones`, `sku`) go inside `body`"

**Implementation:** Already correctly placed in `local.azapi_header.tags`.

### No Validation Required

The provider schema shows no validation functions for the `tags` field. Azure accepts any valid map of strings. No additional validation is needed in `variables.tf`.

### AzAPI Provider 2.0+ Handling

With AzAPI provider 2.0+, `tags` is passed as a native Terraform map directly to the azapi_resource. No `jsonencode()` needed.

## Deferred Work Completion

Checked `following.md` - file does not exist. No work was deferred to this task.

## Critical Review & Edge Case Analysis

### Null Semantics
- **null vs empty map:** When `var.tags = null`, the field is omitted from the API request entirely (standard Azure behavior). When `var.tags = {}`, an empty tags object is sent, which removes all existing tags on update.
- **Current implementation:** With `tags = var.tags` in azapi_header and `ignore_null_property = true`, a null value will be ignored. This matches provider behavior where null tags means "don't modify tags" on update.

### Edge Cases

1. **Empty map (`{}`):** Valid - removes all tags from the resource
2. **Null (`null`):** Valid - leaves tags unchanged (on update) or omits tags (on create)
3. **Large number of tags:** Azure has a limit of 50 tags per resource, but this is enforced by Azure API, not the provider
4. **Special characters in keys/values:** Azure accepts most characters in tag keys/values with some restrictions (e.g., keys cannot be empty, certain reserved prefixes). These are enforced by Azure API validation.

### Idempotency

The implementation is idempotent:
- Applying the same tags repeatedly produces the same result
- Tag order doesn't matter (maps are unordered)
- No state-dependent logic

### Safe References

The implementation safely references `var.tags` which may be null. With `ignore_null_property = true`, null values are handled gracefully by the AzAPI provider.

### Boundary Conditions

- **Tag key length:** Azure limits tag keys to 512 characters
- **Tag value length:** Azure limits tag values to 256 characters
- **Number of tags:** Maximum 50 tags per resource

These are all enforced by the Azure API, not the provider, so no additional validation is required.

## Checklist

- ✅ Property in correct local (`azapi_header` - root level)
- ✅ ForceNew: Not applicable (tags are NOT ForceNew)
- ✅ All logic exactly replicated from provider (direct assignment with no transformations)
- ✅ Validations: None required (provider has no validations for tags)
- ✅ TODO comment: Not applicable (not a sensitive field requiring independent ephemeral variable)
- ✅ Hidden fields checked: None found
- ✅ Deferred work in following.md: Not applicable (no work deferred to other tasks)
- ✅ Deferred work from following.md: Checked - file doesn't exist, no deferred work
- ✅ Critical review completed (null semantics, edge cases, idempotency, safe references)
- ✅ Edge Case Analysis documented
- ✅ Proof created
- ✅ Track.md will be updated to "Pending for check"
- ✅ Self-Review: Implementation only includes `tags` field (Task #10), no other fields added

---

## ✅ CHECKER VALIDATION - APPROVED

**Checked by:** Checker Agent
**Date:** 2026-01-06
**Task:** #10 - tags

### Validation Results

✅ **ForceNew Logic:** Not ForceNew - tags are updatable in place, correctly NOT added to replace_triggers_external_values
✅ **Stable Keys:** Not applicable (no ForceNew triggers for this field)
✅ **Phase Detection:** Field correctly placed in local.azapi_header (root level, not in body)
✅ **Type Conversion:** Correct - map(string) passed directly to azapi_resource.tags with AzAPI 2.0+ (no JSON encoding)
✅ **Null Handling:** Correctly propagates null semantics - null tags are ignored with ignore_null_property = true
✅ **Validations:** None required - provider schema has no validations for tags field
✅ **Deferred Work Completion:** No deferred work for this task (following.md does not exist)
✅ **Deferred Work Recording:** No deferrals made by this task
✅ **Edge Cases:** All edge cases properly analyzed - null vs empty map, idempotency, safe references
✅ **Root-Level Placement:** Correctly placed in azapi_header per executor.md (tags is one of the special root-level fields)

### Compliance Statement

This implementation EXACTLY replicates the provider behavior as required by `executor.md`. The `tags` field is:
- Correctly placed at root level in `azapi_header.tags` (not in body)
- Correctly NOT added to ForceNew triggers (tags are updatable)
- Properly typed as `map(string)` with `default = null`
- Correctly handled with `ignore_null_property = true` for null value semantics
- Free of validations as the provider schema requires none

No deviations, simplifications, or "safer alternatives" were found. The implementation matches the provider's behavior exactly, allowing tags to be created, updated, and removed in place.

**Status:** APPROVED ✅

---
