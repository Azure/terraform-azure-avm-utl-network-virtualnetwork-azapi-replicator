# Task #18 - ip_address_pool.id Argument

## Summary

Implemented the `ip_address_pool.id` argument which maps to `pool.id` in the Azure API structure. This is a Required field within the `ip_address_pool` block that specifies the resource ID of the Network Manager IPAM Pool.

## Shadow Implementation

```hcl
locals {
  body = { 
    properties = {
      addressSpace = {
        ipamPoolPrefixAllocations = (var.ip_address_pool != null && length(var.ip_address_pool) > 0) ? [
          for pool in var.ip_address_pool : {
            pool = {                     # <-
              id = pool.id               # <-
            }                            # <-
          }
        ] : null
      }
    }
  }
}
```

```hcl
# In variables.tf - Added validation for IPAM Pool ID format
variable "ip_address_pool" {
  # ...
  validation {                                                                                                      # <-
    condition = var.ip_address_pool == null || alltrue([                                                            # <-
      for pool in var.ip_address_pool : can(regex("^/subscriptions/[^/]+/resourceGroups/[^/]+/providers/Microsoft\\.Network/networkManagers/[^/]+/ipamPools/[^/]+$", pool.id))  # <-
    ])                                                                                                              # <-
    error_message = "Each id must be a valid IPAM Pool resource ID in the format: /subscriptions/{subscriptionId}/resourceGroups/{resourceGroupName}/providers/Microsoft.Network/networkManagers/{networkManagerName}/ipamPools/{ipamPoolName}"  # <-
  }                                                                                                                 # <-
}
```

## Create Phase Verification

**Query Result:**

From Task #17, the Create phase analysis shows:

```go
func resourceVirtualNetworkCreate(d *pluginsdk.ResourceData, meta interface{}) error {
	// ...
	vnetProperties, routeTables, err := expandVirtualNetworkProperties(ctx, *client, id, d)
	// ...
	vnet := virtualnetworks.VirtualNetwork{
		Name:             pointer.To(id.VirtualNetworkName),
		ExtendedLocation: expandEdgeZoneModel(d.Get("edge_zone").(string)),
		Location:         pointer.To(location.Normalize(d.Get("location").(string))),
		Properties:       vnetProperties,
		Tags:             tags.Expand(d.Get("tags").(map[string]interface{})),
	}
	// ...
	if err := client.CreateOrUpdateThenPoll(ctx, id, vnet); err != nil {
		return fmt.Errorf("creating %s: %+v", id, err)
	}
	// No additional SDK calls after CreateOrUpdateThenPoll
}
```

**Pattern Identification:** Single-phase creation pattern (as documented in Task #17)
- Primary operation: `client.CreateOrUpdateThenPoll(ctx, id, vnet)`
- No post-creation operations

**Field Classification:** The `ip_address_pool.id` argument is processed during the **Create phase** (within primary `CreateOrUpdateThenPoll` operation).

**Decision:** Implement in `local.body` as part of main resource creation.

## Assignment Path Verification

**Predicted Path:** `body.properties.addressSpace.ipamPoolPrefixAllocations[].pool.id`

**Go Code Evidence:**

From `expandVirtualNetworkIPAddressPool`:

```go
func expandVirtualNetworkIPAddressPool(input []interface{}) *[]virtualnetworks.IPamPoolPrefixAllocation {
	if len(input) == 0 {
		return nil
	}

	outputs := make([]virtualnetworks.IPamPoolPrefixAllocation, 0)
	for _, v := range input {
		ipPoolRaw := v.(map[string]interface{})
		output := virtualnetworks.IPamPoolPrefixAllocation{}

		if v, ok := ipPoolRaw["number_of_ip_addresses"]; ok {
			output.NumberOfIPAddresses = pointer.To(v.(string))
		}

		if v, ok := ipPoolRaw["id"]; ok {
			output.Pool = &virtualnetworks.IPamPoolPrefixAllocationPool{
				Id: pointer.To(v.(string)),
			}
		}

		outputs = append(outputs, output)
	}

	return &outputs
}
```

**Assignment Trace:**
1. `ipPoolRaw["id"]` → extracted from Terraform config
2. Creates `IPamPoolPrefixAllocationPool{Id: pointer.To(v.(string))}` → wrapped in Pool struct
3. `output.Pool = &virtualnetworks.IPamPoolPrefixAllocationPool{...}` → assigned to Pool field
4. `properties.AddressSpace.IPamPoolPrefixAllocations = expandVirtualNetworkIPAddressPool(...)` → assigned to AddressSpace
5. In Create: `vnet.Properties = vnetProperties` → properties assigned to VirtualNetwork
6. API sends: `properties.addressSpace.ipamPoolPrefixAllocations[].pool.id`

**Verified Path:** `properties.addressSpace.ipamPoolPrefixAllocations[].pool.id`

**Path Comparison:** ✅ MATCH - Predicted path matches verified path.

## Provider Schema

```go
"ip_address_pool": {
	Type:         pluginsdk.TypeList,
	Optional:     true,
	MaxItems:     2,
	ExactlyOneOf: []string{"address_space", "ip_address_pool"},
	Elem: &pluginsdk.Resource{
		Schema: map[string]*pluginsdk.Schema{
			"id": {
				Type:         pluginsdk.TypeString,
				Required:     true,
				ValidateFunc: ipampools.ValidateIPamPoolID,
			},
			// ... other fields
		},
	},
},
```

**Field Details:**
- **Type:** String (TypeString)
- **Required:** true
- **ValidateFunc:** `ipampools.ValidateIPamPoolID` - validates IPAM Pool resource ID format
- **ForceNew:** false (not specified, meaning updates are allowed)

## Azure API Schema

**Path:** `properties.addressSpace.ipamPoolPrefixAllocations[].pool.id`

**Type:** String

**Structure:**
- Located within the `pool` object inside each `ipamPoolPrefixAllocations` array element
- This field holds the resource ID of the IPAM Pool

From the full Azure API schema query:
```
ipamPoolPrefixAllocations: List(ObjectWithOptionalAttrs(map[string]Type{
  "numberOfIpAddresses": String, 
  "pool": ObjectWithOptionalAttrs(map[string]Type{
    "id": String
  }, []string{"id"})
}, []string{"numberOfIpAddresses", "pool"}))
```

## Hidden Fields Check

**Expand Function Analysis:**

From `expandVirtualNetworkIPAddressPool`:

```go
if v, ok := ipPoolRaw["id"]; ok {
	output.Pool = &virtualnetworks.IPamPoolPrefixAllocationPool{
		Id: pointer.To(v.(string)),
	}
}
```

**Hidden Fields:** ❌ NONE

The expand function only processes the `id` field from Terraform config. No hardcoded values or additional hidden fields are set for the `pool` object.

## Mapping

- `ip_address_pool[].id` (Terraform) → `pool.id` (Azure API)
- Note the wrapping: Terraform's flat `id` field becomes nested under `pool` object in the API

## Special Handling

### Validation

**Provider Validation:**

The provider schema uses `ValidateFunc: ipampools.ValidateIPamPoolID` which validates the resource ID format for IPAM Pools.

**Implementation in variables.tf:**

Added validation block to enforce the IPAM Pool resource ID format:

```hcl
validation {
  condition = var.ip_address_pool == null || alltrue([
    for pool in var.ip_address_pool : can(regex("^/subscriptions/[^/]+/resourceGroups/[^/]+/providers/Microsoft\\.Network/networkManagers/[^/]+/ipamPools/[^/]+$", pool.id))
  ])
  error_message = "Each id must be a valid IPAM Pool resource ID in the format: /subscriptions/{subscriptionId}/resourceGroups/{resourceGroupName}/providers/Microsoft.Network/networkManagers/{networkManagerName}/ipamPools/{ipamPoolName}"
}
```

This validation:
- ✅ Validates the format matches IPAM Pool resource ID pattern
- ✅ Uses `alltrue()` to validate each pool in the list
- ✅ Only validates when `var.ip_address_pool` is not null
- ✅ Provides clear error message with expected format

**Why This is EXACT:**

The regex pattern `^/subscriptions/[^/]+/resourceGroups/[^/]+/providers/Microsoft\\.Network/networkManagers/[^/]+/ipamPools/[^/]+$` precisely matches the IPAM Pool resource ID format enforced by the provider's `ValidateIPamPoolID` function.

### ForceNew

**Schema Analysis:** No `ForceNew: true` in schema for the `id` field.

**CustomizeDiff Check:** No CustomizeDiff logic in the resource function (confirmed in Task #17).

**Decision:** No ForceNew handling needed. Updates are allowed.

### Sensitive/WriteOnly

**Schema Analysis:** No `Sensitive: true` or WriteOnly indicators for the `id` field.

**Decision:** Not sensitive. Use `local.body` (not `sensitive_body`).

### Post-Creation Operations

**Pattern:** Single-phase creation (confirmed in Task #17).

**Decision:** No post-creation operations. Implement in `local.body`.

## Deferred Work Completion

**Check `following.md`:** File does not exist - no deferred work to complete.

## Critical Review & Edge Cases

### Null Semantics

**When `var.ip_address_pool` is `null`:**
- The entire `ipamPoolPrefixAllocations` array is `null`
- The `pool.id` field is never evaluated
- ✅ Correct: handled by parent block conditional

**When `pool.id` is empty string `""`:**
- Provider expand function: `ipPoolRaw["id"]` would return empty string
- Validation will catch this at plan time (regex requires non-empty segments)
- ✅ Safe: validation prevents empty strings

### Boundary Conditions

**ID Format:**
- Must match IPAM Pool resource ID pattern
- ✅ Validation enforces format at plan time
- ✅ Provider uses same validation

**Case Sensitivity:**
- Azure resource IDs are case-insensitive for most components
- Provider does not normalize case
- ✅ We pass through as-is, matching provider behavior

### Idempotency

**Value Assignment:**
- Direct assignment: `pool.id = pool.id`
- No transformations applied
- ✅ Same input produces same output every time

**List Ordering:**
- Parent `for` loop maintains order from `var.ip_address_pool`
- ✅ Deterministic: order preserved across applies

### Safe References

**Null Safety:**
- ✅ Parent block checks `var.ip_address_pool != null && length(var.ip_address_pool) > 0`
- ✅ Loop variable `pool` is always non-null within the `for` expression
- ✅ Field access `pool.id` is safe (variable type definition ensures field exists)

**Object Structure:**
- ✅ `pool` object is always created (not conditional)
- ✅ `id` field is always present within `pool` object
- ✅ Matches provider's behavior of always creating the Pool struct when id exists

## Edge Case Analysis

### Edge Case 1: Multiple Pools with Same ID

**Scenario:** User provides duplicate IPAM Pool IDs in the list

**Provider Behavior:**
- Provider does not validate uniqueness
- Azure API would process all entries
- May result in unexpected behavior from Azure side

**Our Implementation:**
- ✅ Matches provider: no uniqueness validation
- ✅ Pass through all values as-is
- Note: This is intentional - Azure API is responsible for handling duplicates

### Edge Case 2: Invalid Resource ID Format

**Scenario:** User provides malformed IPAM Pool ID

**Provider Behavior:**
- Validation fails at plan time with error
- User must fix before apply

**Our Implementation:**
- ✅ Validation block catches this at plan time
- ✅ Clear error message guides user to correct format
- ✅ Matches provider validation timing

### Edge Case 3: Transitioning Between address_space and ip_address_pool

**Scenario:** User switches from `address_space` to `ip_address_pool`

**Provider Behavior:**
- ExactlyOneOf constraint ensures only one is set
- Resource updates normally (no ForceNew)

**Our Implementation:**
- ✅ ExactlyOneOf validation enforced on both variables
- ✅ No ForceNew trigger
- ✅ Matches provider update behavior

### Edge Case 4: Empty ip_address_pool List

**Scenario:** `var.ip_address_pool = []`

**Provider Behavior:**
- `expandVirtualNetworkIPAddressPool` returns `nil` when length is 0
- No API field sent

**Our Implementation:**
- ✅ Parent block checks `length(var.ip_address_pool) > 0`
- ✅ Returns `null` for empty list
- ✅ Matches provider: `ignore_null_property = true` omits field from API call

## Checklist

- ✅ Field implemented in correct location (`local.body`)
- ✅ Assignment path verified (`properties.addressSpace.ipamPoolPrefixAllocations[].pool.id`)
- ✅ Validation implemented in `variables.tf` (IPAM Pool ID format)
- ✅ ForceNew analysis complete (not needed)
- ✅ CustomizeDiff checked (none applicable)
- ✅ Sensitive/WriteOnly checked (not sensitive)
- ✅ Hidden fields checked (none found)
- ✅ Create phase verified (single-phase pattern)
- ✅ Post-creation operations checked (none)
- ✅ Deferred work checked (none)
- ✅ Null semantics reviewed
- ✅ Edge cases analyzed
- ✅ Idempotency confirmed
- ✅ Safe references verified
- ✅ Mapping documented (`id` → `pool.id`)
- ✅ Provider schema documented
- ✅ Azure API schema documented
- ✅ Proof document created
- ✅ Self-review: Only implemented Task #18 scope (ip_address_pool.id)
- ✅ Ready to update track.md to "Pending for check"

---

## ✅ CHECKER VALIDATION - APPROVED

**Checked by:** Checker Agent
**Date:** 2026-01-06
**Task:** #18 - ip_address_pool.id

### Validation Results

✅ **ForceNew Logic:** Not applicable - no ForceNew required (updates allowed)
✅ **Stable Keys:** N/A - no replace_triggers_external_values entries for this field
✅ **Phase Detection:** Field correctly placed in `local.body` (Create phase)
✅ **Type Conversion:** Direct assignment - string to string (no conversion needed)
✅ **Null Handling:** Correctly propagates null semantics via parent block conditional
✅ **Validations:** IPAM Pool ID format validation implemented in `variables.tf` with proper regex
✅ **Deferred Work Completion:** No deferred work for this task (following.md does not exist)
✅ **Deferred Work Recording:** No deferrals made by this task
✅ **Edge Cases:** All edge cases properly analyzed and handled (empty list, invalid ID format, null semantics, duplicate IDs)
✅ **Assignment Path:** Verified correct path `properties.addressSpace.ipamPoolPrefixAllocations[].pool.id`
✅ **Proof Document:** Complete with all required sections including Create Phase Verification and Assignment Path Verification
✅ **Scope Compliance:** Only implemented Task #18 scope (ip_address_pool.id field within pool object)

### Compliance Statement

This implementation EXACTLY replicates the provider behavior as required by `executor.md`. The validation correctly enforces IPAM Pool resource ID format using regex that matches the provider's `ValidateIPamPoolID` function. The field is properly nested within the `pool` object structure, matching the provider's expand function. No deviations, simplifications, or "safer alternatives" were found.

**Status:** APPROVED ✅

---
