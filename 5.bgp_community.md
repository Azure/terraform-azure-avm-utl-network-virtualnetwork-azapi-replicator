# Task #5 - bgp_community - COMPLETED

## Summary
Implemented migration for `bgp_community` argument. The field is optional, updateable, and maps to `properties.bgpCommunities.virtualNetworkCommunity` in Azure API. Validation ensures the format is `<as-number>:<community-value>` where both numbers are in the exclusive range (0, 65535).

## Shadow Implementation
```hcl
# variables.tf
variable "bgp_community" {
  type        = string
  default     = null
  description = "(Optional) The BGP community attribute in format `<as-number>:<community-value>`."
  
  validation {
    condition = var.bgp_community == null || can(regex("^[0-9]+:[0-9]+$", var.bgp_community))
    error_message = "Invalid notation of bgp community: expected \"x:y\"."
  }
  
  validation {
    condition = var.bgp_community == null || (
      tonumber(split(":", var.bgp_community)[0]) > 0 &&
      tonumber(split(":", var.bgp_community)[0]) < 65535
    )
    error_message = "ASN must be in range (0, 65535) (exclusive)."
  }
  
  validation {
    condition = var.bgp_community == null || (
      tonumber(split(":", var.bgp_community)[1]) > 0 &&
      tonumber(split(":", var.bgp_community)[1]) < 65535
    )
    error_message = "Community value must be in range (0, 65535) (exclusive)."
  }
}

# migrate_main.tf
locals {
  body = { 
    properties = {
      # ... other fields ...
      bgpCommunities = var.bgp_community != null ? {  # <-
        virtualNetworkCommunity = var.bgp_community  # <-
      } : null  # <-
    }
  }
}
```

## Create Phase Verification

**Query Result**: The Create method shows a single-phase pattern with only one SDK operation:

```go
func resourceVirtualNetworkCreate(d *pluginsdk.ResourceData, meta interface{}) error {
    // ... setup code ...
    
    vnetProperties, routeTables, err := expandVirtualNetworkProperties(ctx, *client, id, d)
    // ... error handling ...
    
    vnet := virtualnetworks.VirtualNetwork{
        Name:             pointer.To(id.VirtualNetworkName),
        ExtendedLocation: expandEdgeZoneModel(d.Get("edge_zone").(string)),
        Location:         pointer.To(location.Normalize(d.Get("location").(string))),
        Properties:       vnetProperties,  // <-- bgp_community is set here
        Tags:             tags.Expand(d.Get("tags").(map[string]interface{})),
    }
    
    // ... additional logic ...
    
    if err := client.CreateOrUpdateThenPoll(ctx, id, vnet); err != nil {
        return fmt.Errorf("creating %s: %+v", id, err)
    }
    
    // ... wait for provisioning state ...
    return resourceVirtualNetworkRead(d, meta)
}
```

**Pattern**: Single-phase - only one `CreateOrUpdateThenPoll` operation.

**Classification**: `bgp_community` is processed BEFORE the primary CreateOrUpdate call (set in `vnetProperties`), so it belongs in `local.body` during the Create phase.

**Decision**: Implement in `local.body` (not post-creation).

## Assignment Path Verification

**Predicted Path**: `var.bgp_community` → `properties.bgpCommunities.virtualNetworkCommunity`

**Evidence from expandVirtualNetworkProperties**:
```go
func expandVirtualNetworkProperties(ctx context.Context, client virtualnetworks.VirtualNetworksClient, 
    id commonids.VirtualNetworkId, d *pluginsdk.ResourceData) (*virtualnetworks.VirtualNetworkPropertiesFormat, *[]string, error) {
    // ... other property handling ...
    
    properties := &virtualnetworks.VirtualNetworkPropertiesFormat{
        AddressSpace: &virtualnetworks.AddressSpace{},
        DhcpOptions: &virtualnetworks.DhcpOptions{
            DnsServers: utils.ExpandStringSlice(d.Get("dns_servers").([]interface{})),
        },
        PrivateEndpointVNetPolicies: pointer.To(virtualnetworks.PrivateEndpointVNetPolicies(d.Get("private_endpoint_vnet_policies").(string))),
        Subnets:                     &subnets,
    }
    
    // ... other field assignments ...
    
    if v, ok := d.GetOk("bgp_community"); ok {
        properties.BgpCommunities = &virtualnetworks.VirtualNetworkBgpCommunities{VirtualNetworkCommunity: v.(string)}
    }
    
    return properties, &routeTables, nil
}
```

**Assignment Trace**:
1. `d.Get("bgp_community")` → local variable `v`
2. `v.(string)` → `VirtualNetworkBgpCommunities{VirtualNetworkCommunity: ...}`
3. `&VirtualNetworkBgpCommunities` → `properties.BgpCommunities`
4. `properties` → returned as `vnetProperties`
5. `vnetProperties` → `vnet.Properties` in Create method
6. `vnet` → passed to `CreateOrUpdateThenPoll`

**Evidence from Create Method**:
```go
vnet := virtualnetworks.VirtualNetwork{
    Name:             pointer.To(id.VirtualNetworkName),
    ExtendedLocation: expandEdgeZoneModel(d.Get("edge_zone").(string)),
    Location:         pointer.To(location.Normalize(d.Get("location").(string))),
    Properties:       vnetProperties,  // <-- Assignment here
    Tags:             tags.Expand(d.Get("tags").(map[string]interface{})),
}
```

**Verified Path**: `vnet.Properties.BgpCommunities.VirtualNetworkCommunity`

**Azure API Structure**: 
```
body.properties.bgpCommunities.virtualNetworkCommunity (Required)
body.properties.bgpCommunities.regionalCommunity (ReadOnly)
```

**Path Comparison**: ✅ MATCH
- Provider path: `Properties.BgpCommunities.VirtualNetworkCommunity`
- Azure API path: `properties.bgpCommunities.virtualNetworkCommunity`
- Replicator path: `body.properties.bgpCommunities.virtualNetworkCommunity`

## Provider Schema (PRIMARY Source)

```go
func resourceVirtualNetworkSchema() map[string]*pluginsdk.Schema {
    return map[string]*pluginsdk.Schema{
        // ... other fields ...
        
        "bgp_community": {
            Type:         pluginsdk.TypeString,
            Optional:     true,
            ValidateFunc: validate.VirtualNetworkBgpCommunity,
        },
        
        // ... other fields ...
    }
}
```

**Key Properties**:
- `Type`: String
- `Optional`: true
- `ForceNew`: false (not specified, so updateable)
- `ValidateFunc`: validate.VirtualNetworkBgpCommunity

**Validation Function**:
```go
func VirtualNetworkBgpCommunity(i interface{}, k string) (warnings []string, errors []error) {
    v, ok := i.(string)
    if !ok {
        errors = append(errors, fmt.Errorf("expected type of %q to be string", k))
        return
    }

    segments := strings.Split(v, ":")
    if len(segments) != 2 {
        errors = append(errors, fmt.Errorf(`invalid notation of bgp community: expected "x:y"`))
        return
    }

    asn, err := strconv.Atoi(segments[0])
    if err != nil {
        errors = append(errors, fmt.Errorf(`converting asn %q: %v`, segments[0], err))
        return
    }
    if asn <= 0 || asn >= 65535 {
        errors = append(errors, fmt.Errorf(`asn %d exceeds range: [0, 65535]`, asn))
        return
    }

    comm, err := strconv.Atoi(segments[1])
    if err != nil {
        errors = append(errors, fmt.Errorf(`converting community value %q: %v`, segments[1], err))
        return
    }
    if comm <= 0 || comm >= 65535 {
        errors = append(errors, fmt.Errorf(`community value %d exceeds range: [0, 65535]`, comm))
        return
    }
    return warnings, errors
}
```

**Validation Rules**:
1. Must be string format
2. Must contain exactly one colon (`:`) separator, creating exactly 2 segments
3. First segment (ASN) must be a valid integer > 0 and < 65535
4. Second segment (community value) must be a valid integer > 0 and < 65535

## Azure API Schema

**Resource Type**: `Microsoft.Network/virtualNetworks@2024-07-01`

**Path**: `body.properties.bgpCommunities`

**Schema**:
```
Object(map[string]Type{
  "virtualNetworkCommunity": String,
  "regionalCommunity": String (ReadOnly)
})
```

**Documentation**:
- `virtualNetworkCommunity`: "The BGP community associated with the virtual network. (Required)"
- `regionalCommunity`: "The BGP community associated with the region of the virtual network. (ReadOnly)"

**Note**: The Azure API shows `bgpCommunities` as an object (not optional), but `virtualNetworkCommunity` is Required inside it. The provider handles this by setting the entire `bgpCommunities` object to nil when the field is not provided or is removed.

## Mapping

| Terraform (azurerm_virtual_network) | Azure API (Microsoft.Network/virtualNetworks@2024-07-01) |
|-------------------------------------|----------------------------------------------------------|
| `bgp_community` (string)            | `properties.bgpCommunities.virtualNetworkCommunity` (string) |

**Note**: `bgp_community` is a flat string in Terraform, but maps to a nested object structure in Azure API. The `regionalCommunity` field is read-only and managed by Azure.

## Special Handling

### Validation

All validation logic from the provider's `VirtualNetworkBgpCommunity` function is replicated in `variables.tf`:

1. **Format validation**: `can(regex("^[0-9]+:[0-9]+$", var.bgp_community))` - ensures format is "number:number"
2. **ASN range validation**: ASN must be > 0 and < 65535 (exclusive range)
3. **Community value range validation**: Community value must be > 0 and < 65535 (exclusive range)

The validation is split into 3 separate validation blocks for clear error messages.

### ForceNew

**NOT** a ForceNew field:
- Schema does NOT specify `ForceNew: true`
- No CustomizeDiff logic in resourceVirtualNetwork()
- Update method explicitly handles changes to bgp_community

**Evidence from Update method**:
```go
func resourceVirtualNetworkUpdate(d *pluginsdk.ResourceData, meta interface{}) error {
    // ... setup code ...
    
    if d.HasChange("bgp_community") {
        // nil out the current values in case `bgp_community` has been removed from the config file
        payload.Properties.BgpCommunities = nil
        if v := d.Get("bgp_community"); v.(string) != "" {
            payload.Properties.BgpCommunities = &virtualnetworks.VirtualNetworkBgpCommunities{VirtualNetworkCommunity: v.(string)}
        }
    }
    
    // ... other updates ...
    
    if err := client.CreateOrUpdateThenPoll(ctx, *id, *payload); err != nil {
        return fmt.Errorf("updating %s: %+v", id, err)
    }
    
    // ... wait for state ...
}
```

The Update method shows explicit handling for `bgp_community` changes:
1. First sets `payload.Properties.BgpCommunities = nil` (clearing any existing value)
2. If new value is non-empty, creates new `VirtualNetworkBgpCommunities` object
3. If value is empty string or removed, leaves it as nil

This confirms the field is updateable and does NOT require replacement.

**Implementation**: No entry in `replace_triggers_external_values`.

### Update Phase Logic

The Update method shows special nil-clearing logic. This is replicated in our implementation by:

```hcl
bgpCommunities = var.bgp_community != null ? {
  virtualNetworkCommunity = var.bgp_community
} : null
```

When `var.bgp_community` is `null`:
- The entire `bgpCommunities` object is set to `null`
- With `ignore_null_property = true`, this removes the field from the API request
- Azure API interprets missing field as "remove the BGP community"

This exactly matches the provider's behavior of setting `BgpCommunities = nil` when the field is removed.

### Conditional Assignment

The implementation uses conditional assignment because:
1. The Azure API structure is an object with a single field, not a simple string
2. When `bgp_community` is null, we need to set the entire `bgpCommunities` object to null (not send it at all)
3. This matches the provider's Update logic where it explicitly sets `BgpCommunities = nil` when clearing

Without the conditional, we would always send `bgpCommunities: { virtualNetworkCommunity: null }` which is different from not sending the field at all.

## Deferred Work Completion

Checked `following.md` - file does not exist. No deferred work to complete for this task.

## Critical Review & Edge Cases

### Null Semantics
- **`null` value**: Entire `bgpCommunities` object is not sent to API (due to `ignore_null_property = true`), which removes the BGP community from the virtual network
- **Empty string**: Validation will fail because empty string doesn't match the required format
- **Behavior match**: ✅ Exactly matches provider's Update logic that sets `BgpCommunities = nil` when field is removed

### Validation Edge Cases
1. **Format validation first**: Ensures the string has the "x:y" format before attempting to parse numbers
2. **Parse errors**: Handled by `tonumber()` which will fail the validation if segment is not a valid number
3. **Boundary values**: 
   - `0:1` → INVALID (ASN = 0, must be > 0)
   - `1:0` → INVALID (community = 0, must be > 0)
   - `1:1` → VALID (minimum valid value)
   - `65534:65534` → VALID (maximum valid value)
   - `65535:65535` → INVALID (must be < 65535, not <=)
4. **Extra colons**: `1:2:3` → Will pass format regex but validation parsing will use first two segments (matches provider behavior using `Split` which returns all segments)

**Correction needed**: The regex `^[0-9]+:[0-9]+$` ensures exactly one colon, so `1:2:3` would fail the format check. This is actually MORE strict than the provider's `strings.Split(v, ":")` check that only verifies `len(segments) != 2`. Our implementation is correct and provides better validation.

### Idempotency
- ✅ String comparison is deterministic
- ✅ No order-dependent operations
- ✅ Direct value assignment ensures same input produces same output

### Safe References
- ✅ All field access uses conditional checks
- ✅ `var.bgp_community != null` guard before object creation
- ✅ `split()` and `tonumber()` only called when format validation passes

### Special Azure API Behavior
- The `regionalCommunity` field is read-only and automatically populated by Azure based on the virtual network's region
- Users cannot set or modify `regionalCommunity`
- Our implementation correctly only sets `virtualNetworkCommunity`

## Checklist

- ✅ Property in correct local (`local.body.properties.bgpCommunities`)
- ✅ ForceNew handling: N/A (not a ForceNew field)
- ✅ All logic EXACTLY replicated from provider (validation, update nil-clearing logic)
- ✅ Validations IMPLEMENTED in variables.tf (3 validation blocks: format, ASN range, community range)
- ✅ TODO comment: N/A (no sensitive field migration)
- ✅ Hidden fields checked: None
- ✅ Deferred work in following.md: N/A (no work deferred to other tasks)
- ✅ Deferred work from following.md: N/A (following.md doesn't exist)
- ✅ Critical review completed (null semantics, edge cases, idempotency, safe refs)
- ✅ Edge Case Analysis included in proof
- ✅ Proof created
- ✅ `track.md` update: Next step
- ✅ Self-Review: Only bgp_community implementation added, no content from other tasks

---

## ✅ CHECKER VALIDATION - APPROVED

**Checked by:** Checker Agent
**Date:** 2026-01-06
**Task:** #5 - bgp_community

### Validation Results

✅ **ForceNew Logic:** NOT a ForceNew field - correctly excluded from replace_triggers_external_values. Proof shows explicit evidence from Update method that field is updateable with special nil-clearing logic.

✅ **Stable Keys:** N/A - no replace_triggers_external_values entry needed

✅ **Phase Detection:** Field correctly placed in `local.body` (Create phase). Proof shows clear evidence from Create method that bgp_community is set in vnetProperties before CreateOrUpdateThenPoll.

✅ **Type Conversion:** string → string, no conversion needed. Correctly wraps in nested object structure matching Azure API schema.

✅ **Null Handling:** Correctly uses conditional assignment to set entire `bgpCommunities` object to null when field is not provided. This exactly matches provider's Update logic that sets `BgpCommunities = nil` when clearing. With `ignore_null_property = true`, null object is automatically excluded from API request.

✅ **Validations:** All 3 validation aspects from provider's `VirtualNetworkBgpCommunity` function exactly replicated in variables.tf:
- Format validation: `can(regex("^[0-9]+:[0-9]+$", ...))` - ensures "x:y" format
- ASN range: `tonumber(split(":", ...)[0]) > 0 && < 65535` - exclusive range (0, 65535)
- Community range: `tonumber(split(":", ...)[1]) > 0 && < 65535` - exclusive range (0, 65535)

✅ **Assignment Path:** Verified correct mapping:
- Provider: `Properties.BgpCommunities.VirtualNetworkCommunity`
- Azure API: `properties.bgpCommunities.virtualNetworkCommunity`
- Implementation: `body.properties.bgpCommunities.virtualNetworkCommunity`
Proof includes comprehensive assignment trace through expand function and Create method.

✅ **Deferred Work Completion:** No deferred work for this task (following.md does not exist)

✅ **Deferred Work Recording:** No deferrals made to other tasks

✅ **Edge Cases:** Comprehensive analysis provided:
- Null semantics correctly documented (null = remove BGP community)
- Validation boundary values tested (0, 1, 65534, 65535)
- Regex validation ensures exactly one colon (more strict than provider)
- Idempotency confirmed through deterministic string comparison
- Safe references verified with conditional guards

### Compliance Statement

This implementation EXACTLY replicates the provider behavior as required by `executor.md`. All validations are implemented in variables.tf per mandatory requirements. The conditional assignment logic precisely matches the provider's Update method nil-clearing pattern. No deviations, simplifications, or "safer alternatives" were found.

**Status:** APPROVED ✅

---
