# Task #14 - ddos_protection_plan.enable - Block Argument

## Summary

Implemented the `ddos_protection_plan.enable` argument by replacing the comment placeholder with conditional assignment of `var.ddos_protection_plan.enable` to `properties.enableDdosProtection`. The field is a Required boolean within the ddos_protection_plan block and directly controls whether DDoS Protection is enabled on the Virtual Network.

## Shadow Implementation

```hcl
locals {
  body = {
    properties = {
      enableDdosProtection = var.ddos_protection_plan != null ? var.ddos_protection_plan.enable : null  # <-
    }
  }
}
```

## Create Phase Verification

**Query:** Examined Create method via `resourceVirtualNetworkCreate`

**Pattern:** Single-phase creation

**Go Code Evidence:**
```go
func resourceVirtualNetworkCreate(d *pluginsdk.ResourceData, meta interface{}) error {
    // ...
    vnetProperties, routeTables, err := expandVirtualNetworkProperties(ctx, *client, id, d)
    if err != nil {
        return err
    }
    // ...
    vnet := virtualnetworks.VirtualNetwork{
        Name:             pointer.To(id.VirtualNetworkName),
        ExtendedLocation: expandEdgeZoneModel(d.Get("edge_zone").(string)),
        Location:         pointer.To(location.Normalize(d.Get("location").(string))),
        Properties:       vnetProperties,  // <- enableDdosProtection included in Properties
        Tags:             tags.Expand(d.Get("tags").(map[string]interface{})),
    }
    // ...
    if err := client.CreateOrUpdateThenPoll(ctx, id, vnet); err != nil {
        return fmt.Errorf("creating %s: %+v", id, err)
    }
    // ...
}
```

**Classification:** The `ddos_protection_plan.enable` field is processed in the primary Create phase via `expandVirtualNetworkProperties`, which is called before the main `CreateOrUpdateThenPoll` operation. No post-creation operations exist for this field.

**Decision:** Implement in `local.body.properties.enableDdosProtection` as part of main resource creation (not a post-creation operation).

## Assignment Path Verification

**Predicted Path:**
- Terraform: `var.ddos_protection_plan.enable` → Azure API: `properties.enableDdosProtection`

**Go Code Evidence:**

From `expandVirtualNetworkProperties`:
```go
if v, ok := d.GetOk("ddos_protection_plan"); ok {
    rawList := v.([]interface{})

    var ddosPPlan map[string]interface{}
    if len(rawList) > 0 {
        ddosPPlan = rawList[0].(map[string]interface{})
    }

    // ... id processing ...

    if v, ok := ddosPPlan["enable"]; ok {
        enable := v.(bool)  // <- Extract boolean value
        properties.EnableDdosProtection = &enable  // <- Direct assignment
    }
}
```

From Create method:
```go
vnet := virtualnetworks.VirtualNetwork{
    Properties: vnetProperties,  // <- .Properties assignment adds nesting
}
```

**Verified Path:**
- `var.ddos_protection_plan.enable` → `properties.EnableDdosProtection` → `properties.enableDdosProtection` (Azure API, camelCase)

**Path Comparison:** ✅ Match - The `enable` field is extracted as a boolean, assigned directly to `properties.EnableDdosProtection`, which is part of the `vnetProperties` returned by `expandVirtualNetworkProperties`, and becomes `vnet.Properties.EnableDdosProtection` in the SDK payload, mapping to `properties.enableDdosProtection` in Azure API.

## Provider Schema

**Go Source:**
```go
"ddos_protection_plan": {
    Type:     pluginsdk.TypeList,
    Optional: true,
    MaxItems: 1,
    Elem: &pluginsdk.Resource{
        Schema: map[string]*pluginsdk.Schema{
            "id": {
                Type:         pluginsdk.TypeString,
                Required:     true,
                ValidateFunc: ddosprotectionplans.ValidateDdosProtectionPlanID,
            },

            "enable": {
                Type:     pluginsdk.TypeBool,
                Required: true,
            },
        },
    },
},
```

**Key Attributes:**
- Type: Bool
- Required: true (within the ddos_protection_plan block)
- ForceNew: false (not specified)
- ValidateFunc: None (no validation beyond type checking)

## Azure API Schema

**Query:** `Microsoft.Network/virtualNetworks@2024-07-01`

**Path:** `body.properties.enableDdosProtection`

**Schema Type:** `Bool`

**Property Path:**
- `body.properties.enableDdosProtection` - Optional, Bool

## Hidden Fields

**Expand Function Analysis:**

Examined `expandVirtualNetworkProperties` for the `enable` field processing:

```go
if v, ok := ddosPPlan["enable"]; ok {
    enable := v.(bool)
    properties.EnableDdosProtection = &enable
}
```

**Result:** ✅ No hidden fields found. The expand function only processes the `enable` field from the schema and directly assigns it to the `EnableDdosProtection` property without adding any hardcoded, computed, or default values.

## Mapping

**Terraform → Azure API:**
- Field: `ddos_protection_plan.enable` → `properties.enableDdosProtection`

**Naming Convention:** snake_case → camelCase

## Special Handling

### Validation

**Provider Validation:** The provider schema does NOT include any ValidateFunc for the `enable` field. It's simply a Required boolean with no additional constraints.

**Implementation:** No validation block needed in `variables.tf` since:
1. The field is already Required within the parent block (Terraform type system enforces this)
2. Type checking (bool) is automatically enforced by Terraform
3. No custom validation logic exists in the provider

**Note:** The parent block validation ensuring both `id` and `enable` are provided when `ddos_protection_plan` is set is already handled by the Required attribute in the type definition in `variables.tf`.

### ForceNew Handling

**Analysis:** The schema does NOT include `ForceNew: true` for the `enable` field, and there is no CustomizeDiff logic found in the resource function that would trigger ForceNew for this field.

**Decision:** Do NOT add to `replace_triggers_external_values` since the field supports in-place updates.

### Conditional Assignment

**Pattern:** The field is conditionally assigned based on the parent block:
```hcl
enableDdosProtection = var.ddos_protection_plan != null ? var.ddos_protection_plan.enable : null
```

**Reason:** 
- The parent block `ddos_protection_plan` is Optional in the provider schema
- When the block is null, the entire feature should not be configured
- The field is Required within the block, so when the block exists, the boolean value must be present
- With `ignore_null_property = true`, the null value will be ignored when the parent block is not set

**Implementation:** Uses direct conditional assignment matching the provider's expand function behavior.

## Deferred Work Completion

**Check:** Examined `following.md` for any work deferred to this task.

**Result:** ✅ No `following.md` file exists, meaning no work has been deferred to this task.

## Critical Review & Edge Case Analysis

### Null Semantics
- **Block null:** When `var.ddos_protection_plan == null`, `enableDdosProtection` is set to `null`, which will be ignored by Azure API due to `ignore_null_property = true`
- **Field Required within block:** The `enable` field is Required within the `ddos_protection_plan` block, so when the block is set, the `enable` value must be provided
- **Correct behavior:** Matches provider's expand function which only sets `EnableDdosProtection` when the parent block exists and the field is present

### Edge Cases
1. **Boolean false vs null:** Important distinction - `false` means "explicitly disable DDoS protection" while `null` means "don't configure DDoS protection at all"
2. **Block without enable:** Cannot occur because `enable` is Required within the block; Terraform type system prevents this
3. **Idempotency with boolean values:** Boolean values are inherently deterministic and idempotent (no order dependency, no ambiguity)

### Idempotency
- ✅ No order-dependent logic
- ✅ Deterministic output based solely on input variable
- ✅ Direct boolean assignment ensures consistent behavior across applies
- ✅ No complex transformations that could introduce non-determinism

### Safe References
- ✅ Conditional check `var.ddos_protection_plan != null` at parent level protects against null reference errors
- ✅ Direct field access `var.ddos_protection_plan.enable` is safe because:
  - The parent conditional ensures the object exists before accessing the field
  - The field is Required within the block, so Terraform's type system ensures it's present
- ✅ No nested conditionals needed due to Required attribute

### Provider Behavior Match
- ✅ **Direct assignment:** Implementation exactly matches the provider's expand function which directly assigns the boolean value
- ✅ **No validation:** Correctly identified no additional validation needed beyond type checking
- ✅ **No transformation:** No additional logic, transformations, or defaults - just direct passthrough
- ✅ **Conditional presence:** Field is only included when parent block exists, matching provider behavior
- ✅ **Boolean semantics:** Preserves the distinction between `false` (explicit disable) and `null` (no configuration)

## Checklist

- ✅ Property in correct local (`local.body.properties.enableDdosProtection`)
- ✅ Placeholder comment replaced with actual implementation
- ✅ No validation needed in variables.tf (Required attribute + type checking sufficient)
- ✅ Logic exactly replicated from provider (direct boolean assignment)
- ✅ Hidden fields checked - none found
- ✅ Deferred work checked - none found
- ✅ ForceNew analyzed - not required (no ForceNew in schema)
- ✅ Critical review completed (null, edge cases, idempotency, safe refs)
- ✅ Edge Case Analysis section added
- ✅ Proof document created
- ✅ Self-Review: Only implemented ddos_protection_plan.enable field (Task #14 scope)
- ✅ Track.md will be updated to "Pending for check"

---

## ✅ CHECKER VALIDATION - APPROVED

**Checked by:** Checker Agent
**Date:** 2026-01-06
**Task:** #14 - ddos_protection_plan.enable

### Validation Results

✅ **ForceNew Logic:** Not required (no ForceNew in schema, no CustomizeDiff logic)
✅ **Stable Keys:** N/A (field not in replace_triggers_external_values)
✅ **Phase Detection:** Field correctly placed in `local.body.properties` (Create phase)
✅ **Type Conversion:** Correct - Bool to Bool (direct passthrough)
✅ **Null Handling:** Correctly uses conditional based on parent block; null ignored by `ignore_null_property = true`
✅ **Validations:** None required - Required attribute + type checking sufficient per provider schema
✅ **Deferred Work Completion:** No deferred work for this task (no following.md exists)
✅ **Deferred Work Recording:** No deferrals made by this task
✅ **Edge Cases:** All edge cases properly analyzed - boolean false vs null semantics, idempotency, safe references
✅ **Assignment Path:** Correctly traced through expand function to Azure API path
✅ **Hidden Fields:** None found - expand function only processes enable field directly
✅ **Conditional Logic:** Parent block check correctly implemented matching provider behavior

### Compliance Statement

This implementation EXACTLY replicates the provider behavior as required by `executor.md`. The implementation:
- Directly assigns boolean value when parent block exists, matching expand function logic
- Correctly handles null parent block with null assignment
- No validation needed beyond type system (matching provider schema)
- No ForceNew needed (field supports in-place updates)
- No transformations, simplifications, or deviations from provider behavior

**Status:** APPROVED ✅

---
