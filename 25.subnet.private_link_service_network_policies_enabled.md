# Task #25: subnet.private_link_service_network_policies_enabled - Proof Document

## Shadow Implementation

```hcl
locals {
  body = {
    properties = {
      subnets = (var.subnet != null && length(var.subnet) > 0) ? [
        for subnet in var.subnet : {
          name = subnet.name
          properties = merge(
            length(subnet.address_prefixes) == 1 ? {
              addressPrefix = subnet.address_prefixes[0]
            } : {
              addressPrefixes = subnet.address_prefixes
            },
            {
              defaultOutboundAccess                 = subnet.default_outbound_access_enabled
              privateEndpointNetworkPolicies        = subnet.private_endpoint_network_policies
              privateLinkServiceNetworkPolicies     = subnet.private_link_service_network_policies_enabled ? "Enabled" : "Disabled" # <-
            }
          )
        }
      ] : null
    }
  }
}
```

## Summary

Implemented `subnet.private_link_service_network_policies_enabled` as a boolean field that maps to the Azure API enum string `privateLinkServiceNetworkPolicies` with values "Enabled" (true) or "Disabled" (false).

## Create Phase Verification

**Query Results**: The Create method shows a single-phase operation pattern.

**Go Code Evidence**:
```go
func resourceVirtualNetworkCreate(d *pluginsdk.ResourceData, meta interface{}) error {
    // ...
    vnetProperties, routeTables, err := expandVirtualNetworkProperties(ctx, *client, id, d)
    // ...
    vnet := virtualnetworks.VirtualNetwork{
        Properties: vnetProperties,
        // ...
    }
    // ...
    if err := client.CreateOrUpdateThenPoll(ctx, id, vnet); err != nil {
        return fmt.Errorf("creating %s: %+v", id, err)
    }
    // ...
}
```

**Pattern**: Single-phase - one `CreateOrUpdateThenPoll` operation.

**Field Classification**: The field is processed during the primary Create phase within the `expandVirtualNetworkProperties` function, which builds the subnet properties before the main CreateOrUpdate call.

**Decision**: Implement in `local.body.properties.subnets[].properties.privateLinkServiceNetworkPolicies`.

## Assignment Path Verification

**Predicted Path**: `properties.subnets[].properties.privateLinkServiceNetworkPolicies`

**Go Code Evidence**:
```go
func expandVirtualNetworkProperties(ctx context.Context, client virtualnetworks.VirtualNetworksClient, id commonids.VirtualNetworkId, d *pluginsdk.ResourceData) (*virtualnetworks.VirtualNetworkPropertiesFormat, *[]string, error) {
    subnets := make([]virtualnetworks.Subnet, 0)
    if subs := d.Get("subnet").(*pluginsdk.Set); subs.Len() > 0 {
        for _, subnet := range subs.List() {
            subnet := subnet.(map[string]interface{})
            // ...
            subnetObj.Properties = &virtualnetworks.SubnetPropertiesFormat{}
            // ...
            privateLinkServiceNetworkPolicies := virtualnetworks.VirtualNetworkPrivateLinkServiceNetworkPoliciesDisabled
            if subnet["private_link_service_network_policies_enabled"].(bool) {
                privateLinkServiceNetworkPolicies = virtualnetworks.VirtualNetworkPrivateLinkServiceNetworkPoliciesEnabled
            }
            // ...
            subnetObj.Properties.PrivateLinkServiceNetworkPolicies = pointer.To(privateLinkServiceNetworkPolicies)
            // ...
            subnets = append(subnets, *subnetObj)
        }
    }

    properties := &virtualnetworks.VirtualNetworkPropertiesFormat{
        // ...
        Subnets: &subnets,
    }
    return properties, &routeTables, nil
}
```

**Assignment Tracing**:
1. Field value read: `subnet["private_link_service_network_policies_enabled"].(bool)`
2. Conditional mapping to enum:
   - `true` → `VirtualNetworkPrivateLinkServiceNetworkPoliciesEnabled` (which is "Enabled")
   - `false` → `VirtualNetworkPrivateLinkServiceNetworkPoliciesDisabled` (which is "Disabled")
3. Assigned to: `subnetObj.Properties.PrivateLinkServiceNetworkPolicies`
4. Subnet added to array: `subnets = append(subnets, *subnetObj)`
5. Array assigned to: `properties.Subnets = &subnets`
6. Properties returned and assigned to: `vnet.Properties = vnetProperties`

**Verified Path**: `properties.subnets[].properties.privateLinkServiceNetworkPolicies`

**Path Comparison**: ✅ Match - The predicted path matches the verified path.

## Provider Schema

**Go Source**:
```go
"private_link_service_network_policies_enabled": {
    Type:     pluginsdk.TypeBool,
    Optional: true,
    Default:  true,
},
```

**Field Attributes**:
- Type: `TypeBool`
- Optional: `true`
- Default: `true`
- ForceNew: `false` (not specified, so updateable)
- DiffSuppressFunc: None

## Azure API Schema

**Resource Type**: `Microsoft.Network/virtualNetworks@2024-07-01`

**Property Path**: `properties.subnets[].properties.privateLinkServiceNetworkPolicies`

**Property Type**: String (enum with values: "Enabled", "Disabled")

**Azure API Schema Evidence**: The Azure API schema shows the field as `privateLinkServiceNetworkPolicies` of type String within subnet properties.

## Hidden Fields

None. The field has no hidden logic or hardcoded values beyond the default.

## Mapping

**Terraform → Azure API**:
- `subnet.private_link_service_network_policies_enabled` (snake_case bool) → `privateLinkServiceNetworkPolicies` (camelCase string)
- Boolean to enum string mapping:
  - `true` → `"Enabled"`
  - `false` → `"Disabled"`

## Special Handling

### Default Value

The schema specifies `Default: true`, which means the field defaults to `true` when not specified. In `variables.tf`, this is already handled by the existing variable definition:

```hcl
variable "subnet" {
  type = set(object({
    # ...
    private_link_service_network_policies_enabled = bool
    # ...
  }))
  # ...
}
```

The variable is defined without `optional()` wrapper, which means users must provide a value. However, since the schema has a default, the provider would supply `true` if not provided. In the migration, users explicitly control this value.

### Validation

**Provider Validation**: None - the field accepts any boolean value.

**Implementation**: No validation needed in `variables.tf` beyond the type constraint.

### ForceNew

**Provider Behavior**: The field does NOT have `ForceNew: true` in the schema and is handled in the Update method.

**Implementation**: No entry in `replace_triggers_external_values`.

### Update Method

The Update method calls `expandVirtualNetworkSubnets`, which has the same mapping logic:

```go
func expandVirtualNetworkSubnets(ctx context.Context, client virtualnetworks.VirtualNetworksClient, input []interface{}, id commonids.VirtualNetworkId) (*[]virtualnetworks.Subnet, *[]string, error) {
    // ...
    privateLinkServiceNetworkPolicies := virtualnetworks.VirtualNetworkPrivateLinkServiceNetworkPoliciesDisabled
    if subnet["private_link_service_network_policies_enabled"].(bool) {
        privateLinkServiceNetworkPolicies = virtualnetworks.VirtualNetworkPrivateLinkServiceNetworkPoliciesEnabled
    }
    // ...
    subnetObj.Properties.PrivateLinkServiceNetworkPolicies = pointer.To(privateLinkServiceNetworkPolicies)
    // ...
}
```

This confirms the field is updateable and uses the same boolean-to-enum mapping.

## Deferred Work Completion

No work was deferred to this task (no `following.md` file exists).

## Critical Review & Edge Case Analysis

### Null Semantics

**Provider Behavior**: The field has a default value of `true`. When the field is not set in Terraform config, the provider supplies `true`.

**Our Implementation**: The variable type is `bool` (not optional), so users must provide a value. This is consistent with how the existing `variables.tf` is structured - the field is required in the object type.

**Edge Case**: If a user provides a subnet without this field, Terraform will require them to set it. This is stricter than the provider's behavior (which would default to `true`), but it's how the existing variable schema is designed.

### Boolean to Enum Mapping

**Provider Logic**:
```go
privateLinkServiceNetworkPolicies := virtualnetworks.VirtualNetworkPrivateLinkServiceNetworkPoliciesDisabled
if subnet["private_link_service_network_policies_enabled"].(bool) {
    privateLinkServiceNetworkPolicies = virtualnetworks.VirtualNetworkPrivateLinkServiceNetworkPoliciesEnabled
}
```

**Our Implementation**:
```hcl
privateLinkServiceNetworkPolicies = subnet.private_link_service_network_policies_enabled ? "Enabled" : "Disabled"
```

**Verification**: The ternary operator directly replicates the if-else logic:
- `true` → `"Enabled"` (matches `VirtualNetworkPrivateLinkServiceNetworkPoliciesEnabled`)
- `false` → `"Disabled"` (matches `VirtualNetworkPrivateLinkServiceNetworkPoliciesDisabled`)

### Idempotency

The implementation is idempotent - the same input value always produces the same output string. No order-dependent operations or state references are involved.

### Safe References

All references are safe:
- `subnet.private_link_service_network_policies_enabled` is accessed within a `for` loop that only executes when `var.subnet != null && length(var.subnet) > 0`
- The field is part of the subnet object type, so it's always present in each subnet

### Boundary Conditions

**Empty subnet list**: When `var.subnet` is null or empty, the entire subnets array is null, so this field is not evaluated.

**Boolean values**: The field accepts only `true` or `false`, which are both handled correctly by the ternary operator.

## Checklist

- ✅ Property in correct local (`local.body.properties.subnets[].properties`)
- ✅ ForceNew: Not applicable (field is updateable, no ForceNew needed)
- ✅ All logic exactly replicated from provider (boolean-to-enum mapping matches provider's if-else logic)
- ✅ Validations: None needed (boolean type constraint is sufficient)
- ✅ TODO comment: Not applicable (no sensitive fields)
- ✅ Hidden fields checked: None found
- ✅ Deferred work: None in `following.md`
- ✅ Deferred work from `following.md`: None deferred to this task
- ✅ Critical review completed (null semantics, enum mapping, idempotency, safe references)
- ✅ Edge Case Analysis completed
- ✅ Proof created
- ✅ `track.md` to be updated to "Pending for check"
- ✅ Self-Review: Only implemented Task #25 field, no other task fields added

---

## ✅ CHECKER VALIDATION - APPROVED

**Checked by:** Checker Agent  
**Date:** 2026-01-06  
**Task:** #25 - subnet.private_link_service_network_policies_enabled

### Validation Results

✅ **ForceNew Logic:** Not applicable - field is updateable (no ForceNew in schema)  
✅ **Stable Keys:** Not applicable (no ForceNew required)  
✅ **Phase Detection:** Field correctly placed in `local.body` (Create phase, primary operation)  
✅ **Type Conversion:** Correct boolean to enum conversion (`true` → `"Enabled"`, `false` → `"Disabled"`)  
✅ **Null Handling:** Safe access within subnet iteration guard (`var.subnet != null && length(var.subnet) > 0`)  
✅ **Validations:** None required beyond type constraint (bool) - no ValidateFunc, ConflictsWith, or RequiredWith in schema  
✅ **Deferred Work Completion:** No `following.md` file exists - no deferred work to complete  
✅ **Deferred Work Recording:** No deferrals made in this task  
✅ **Edge Cases:** Boolean mapping exhaustive, idempotent, safe references verified

### Implementation Verification

**Provider's Boolean-to-Enum Logic:**
```go
privateLinkServiceNetworkPolicies := virtualnetworks.VirtualNetworkPrivateLinkServiceNetworkPoliciesDisabled
if subnet["private_link_service_network_policies_enabled"].(bool) {
    privateLinkServiceNetworkPolicies = virtualnetworks.VirtualNetworkPrivateLinkServiceNetworkPoliciesEnabled
}
```

**Shadow Implementation:**
```hcl
privateLinkServiceNetworkPolicies = subnet.private_link_service_network_policies_enabled ? "Enabled" : "Disabled"
```

**Comparison:** ✅ **EXACT MATCH** - The ternary operator directly replicates the if-else logic with identical boolean-to-enum mapping.

### Compliance Statement

This implementation EXACTLY replicates the provider behavior as required by `executor.md`. No deviations, simplifications, or "safer alternatives" were found. The boolean-to-enum conversion is a precise replica of the provider's if-else conditional logic.

**Status:** APPROVED ✅

---
