# Task #30: subnet.id - Computed Output Field

## Summary
The `subnet.id` field is a **computed-only output field** that is automatically populated by Azure API after subnet creation. It does NOT require any implementation in `migrate_main.tf` because it is read-only and never sent in the request body. The AzAPI provider will automatically include this field in the response output.

## Provider Schema Evidence

From `resourceVirtualNetworkSchema()`:

```go
"subnet": {
    Type:       pluginsdk.TypeSet,
    Optional:   true,
    Computed:   true,
    ConfigMode: pluginsdk.SchemaConfigModeAttr,
    Elem: &pluginsdk.Resource{
        Schema: map[string]*pluginsdk.Schema{
            // ... other fields ...
            "id": {
                Type:     pluginsdk.TypeString,
                Computed: true,  // <- COMPUTED ONLY - NO INPUT
            },
        },
    },
},
```

**Key Points:**
- `Computed: true` - This is a read-only field
- No `Optional: true` or `Required: true` - Cannot be set by user
- Not present in expand functions (not sent to API)

## Create Phase Verification

Queried the Create method to verify the field is NOT part of the request:

```go
func resourceVirtualNetworkCreate(d *pluginsdk.ResourceData, meta interface{}) error {
    // ... code ...
    
    subnets, err := expandVirtualNetworkSubnets(d.Get("subnet").(*pluginsdk.Set))
    // The expand function does NOT read subnet.id from input
    
    vnet := virtualnetworks.VirtualNetwork{
        Properties: &virtualnetworks.VirtualNetworkPropertiesFormat{
            Subnets: subnets,
            // subnet.id is NOT set here - it's generated by Azure
        },
    }
    
    // Single-phase pattern: CreateOrUpdateThenPoll
    if err := client.CreateOrUpdateThenPoll(ctx, id, vnet); err != nil {
        return fmt.Errorf("creating %s: %+v", id, err)
    }
    // After creation, Azure API returns subnets with id populated
}
```

**Classification:** Single-phase Create operation. The `subnet.id` field is NOT sent to API - it's generated by Azure and returned in the response.

## Read Phase Evidence

From `flattenVirtualNetworkSubnets()`:

```go
func flattenVirtualNetworkSubnets(input *[]virtualnetworks.Subnet) (*pluginsdk.Set, error) {
    results := &pluginsdk.Set{
        F: resourceAzureSubnetHash,
    }

    if subnets := input; subnets != nil {
        for _, subnet := range *input {
            output := map[string]interface{}{}

            if id := subnet.Id; id != nil {
                output["id"] = *id  // <- Read from API response
            }

            if name := subnet.Name; name != nil {
                output["name"] = *name
            }
            
            // ... other fields ...
            
            results.Add(output)
        }
    }

    return results, nil
}
```

**Flow:** Azure API returns `subnet.Id` → Flatten function reads it → Terraform state stores it

## Azure API Schema

The Azure API schema for `Microsoft.Network/virtualNetworks@2024-07-01` shows:

```
body.properties.subnets: List(ObjectWithOptionalAttrs(map[string]Type{
    "id": String,  // Present in schema but read-only
    "name": String,
    "properties": ...
}))
```

The `id` field is present in the API response schema, but it's **generated by Azure** and **read-only**. According to Azure Resource Manager conventions, the `id` field in nested resources is always a computed identifier assigned by the service.

## Assignment Path Verification

**No assignment path** - This field is NOT assigned in the request body.

**Predicted path:** N/A (not sent to API)

**Verified path:** N/A (not sent to API)

**API returns:** The subnet `id` is returned in the response at `properties.subnets[].id`

## Mapping

- **Terraform field:** `subnet[*].id` (computed output)
- **API field:** `properties.subnets[].id` (read-only, returned by Azure)
- **Replicator implementation:** No implementation needed - field is automatically available in AzAPI output

## Implementation Decision

**NO IMPLEMENTATION REQUIRED** in `migrate_main.tf` because:

1. ✅ The field is `Computed: true` only (read-only)
2. ✅ It's never sent in the request body (not in expand functions)
3. ✅ Azure automatically generates this ID after subnet creation
4. ✅ AzAPI provider automatically includes all response fields in `output`
5. ✅ Users can access via `azapi_resource.this.output.properties.subnets[*].id`

**Current Implementation Status:** 
- No code changes needed in `migrate_main.tf`
- No placeholder comment to replace
- Field is already handled by AzAPI provider's automatic output mapping

## Special Handling

### Computed-Only Field Pattern

This is a computed-only field that follows the standard Azure pattern:
- **Input:** Not included in request body
- **Output:** Automatically populated by Azure API
- **Access:** Available via `azapi_resource.*.output.properties.subnets[*].id`

### No ForceNew Logic

Since this field cannot be set by users, there's no ForceNew logic to implement.

### No Validation Logic

Since this field is computed-only, there are no input validations to implement.

## Critical Review & Edge Cases

### Null Semantics
- **N/A** - Field is always present in Azure API response (non-nullable computed field)

### Boundary Conditions
- **Empty list:** When `var.subnet` is null or empty, no subnets are created, so no IDs are returned
- **Multiple subnets:** Each subnet gets its own unique ID in the format: `/subscriptions/{sub}/resourceGroups/{rg}/providers/Microsoft.Network/virtualNetworks/{vnet}/subnets/{subnet-name}`

### Idempotency
- **Guaranteed by Azure:** The same subnet name always gets the same ID (deterministic based on parent VNet ID + subnet name)

### Safe References
- **Output access:** Users should use `try()` when accessing subnet IDs to handle cases where subnets might not exist:
  ```hcl
  output "subnet_ids" {
    value = try([for s in azapi_resource.this.output.properties.subnets : s.id], [])
  }
  ```

## Edge Case Analysis

1. **Subnet creation with id in input:** The provider schema doesn't allow setting `id` as it's computed-only. If present in `var.subnet`, it will be ignored (as seen in main.tf line 42 - it's read from variable but not used in expand).

2. **Subnet ID format:** Azure generates IDs in the format: `/subscriptions/{subscriptionId}/resourceGroups/{resourceGroupName}/providers/Microsoft.Network/virtualNetworks/{virtualNetworkName}/subnets/{subnetName}`. This is deterministic and consistent.

3. **Multiple applies:** The subnet ID remains stable across applies as long as the subnet name doesn't change (name is part of the ID).

## Checklist

- ✅ Property in correct local: N/A - Not added to any local (computed-only)
- ✅ ForceNew wrapped: N/A - Not applicable for computed fields
- ✅ ALL logic EXACTLY replicated from provider: Yes - No logic to replicate (computed-only)
- ✅ Validations IMPLEMENTED in variables.tf: N/A - No input validations for computed fields
- ✅ TODO comment added to original field in variables.tf: N/A - Field remains in variable for compatibility
- ✅ Hidden fields checked: None
- ✅ Deferred work in following.md: None
- ✅ Deferred work from following.md: None (file doesn't exist)
- ✅ Critical review: Completed above
- ✅ Edge Case Analysis: Completed above
- ✅ Proof created: This document
- ✅ track.md updated: Will update to "Pending for check"
- ✅ Self-Review: No code changes made (correct for computed-only field)

## Conclusion

The `subnet.id` field is a **computed-only output field** that requires **no implementation** in the Replicator Module. The AzAPI provider automatically includes all response fields in the `output` attribute, making this field accessible to users without any additional code. This task is complete with zero code changes.

---

## ✅ CHECKER VALIDATION - APPROVED

**Checked by:** Checker Agent
**Date:** 2026-01-06
**Task:** #30 - subnet.id

### Validation Results

✅ **Field Classification:** Correctly identified as computed-only (Computed: true, no Optional/Required)
✅ **Provider Schema Evidence:** Accurate - field is read-only in provider schema
✅ **Create Phase Verification:** Correct - field NOT sent in expand function, generated by Azure
✅ **Implementation Decision:** Correct - NO code changes needed for computed-only fields
✅ **migrate_main.tf Inspection:** Verified subnet implementation (lines 58-91) does NOT include id field in request body
✅ **Output Availability:** Field automatically available via azapi_resource.*.output.properties.subnets[*].id
✅ **ForceNew Logic:** N/A - Not applicable for computed fields
✅ **Stable Keys:** N/A - Not applicable for computed fields
✅ **Phase Detection:** N/A - Field not sent to API
✅ **Type Conversion:** N/A - Field not sent to API
✅ **Null Handling:** N/A - Field always present in Azure response
✅ **Validations:** N/A - No input validations for computed fields
✅ **Deferred Work Completion:** No deferred work exists for this task
✅ **Deferred Work Recording:** No deferrals made
✅ **Edge Cases:** Properly analyzed - ID format, deterministic generation, stability

### Compliance Statement

This implementation EXACTLY follows executor.md requirements for computed-only fields. The executor correctly identified that:
1. Computed-only fields (Computed: true without Optional/Required) should NOT be added to request body
2. AzAPI provider automatically includes all response fields in output
3. No code changes are required
4. Users can access the field via output path

The proof document provides comprehensive evidence from provider source code (schema definition, flatten function) and Azure API schema. The implementation in migrate_main.tf correctly omits this field from the subnet structure sent to the API.

**Status:** APPROVED ✅

---
