# Task #23: subnet.default_outbound_access_enabled

## Summary
Implemented the `subnet.default_outbound_access_enabled` field, which controls default outbound internet access for the subnet. The field is Optional with a default of `true` and is assigned directly to `properties.defaultOutboundAccess` in the Azure API. No ForceNew behavior, no validations required beyond type checking.

## Create Phase Verification

### Query Result
Queried `resourceVirtualNetworkCreate` function to understand the creation flow.

### Pattern Identification
Single-phase creation pattern:
1. Primary operation: `client.CreateOrUpdateThenPoll(ctx, id, vnet)` - creates the virtual network with all properties including subnets

### Field Classification
The `default_outbound_access_enabled` field is processed in the **Create phase** within the primary `CreateOrUpdateThenPoll` operation. It's set during subnet expansion before the main API call.

### Evidence from Go Code
```go
// From expandVirtualNetworkSubnets and expandVirtualNetworkProperties
subnetObj.Properties.DefaultOutboundAccess = pointer.To(subnet["default_outbound_access_enabled"].(bool))
```

### Decision
Implement in `local.body.properties.subnets[].properties.defaultOutboundAccess`.

## Assignment Path Verification

### Predicted Path
`body.properties.subnets[].properties.defaultOutboundAccess`

### Go Code Evidence - Tracing All Assignments

**Step 1: Field retrieval in expand function**
```go
// From expandVirtualNetworkSubnets (line ~893) and expandVirtualNetworkProperties (line ~1042)
subnetObj.Properties.DefaultOutboundAccess = pointer.To(subnet["default_outbound_access_enabled"].(bool))
```

**Step 2: Subnet object construction**
```go
// The subnetObj is of type *virtualnetworks.Subnet
// It's added to the subnets slice
subnets = append(subnets, *subnetObj)
```

**Step 3: Properties construction in expandVirtualNetworkProperties**
```go
properties := &virtualnetworks.VirtualNetworkPropertiesFormat{
    // ... other properties
    Subnets: &subnets,
}
```

**Step 4: VNet construction in resourceVirtualNetworkCreate**
```go
vnet := virtualnetworks.VirtualNetwork{
    Name:             pointer.To(id.VirtualNetworkName),
    ExtendedLocation: expandEdgeZoneModel(d.Get("edge_zone").(string)),
    Location:         pointer.To(location.Normalize(d.Get("location").(string))),
    Properties:       vnetProperties,  // <- This is the properties from above
    Tags:             tags.Expand(d.Get("tags").(map[string]interface{})),
}
```

**Step 5: API call**
```go
if err := client.CreateOrUpdateThenPoll(ctx, id, vnet); err != nil {
    return fmt.Errorf("creating %s: %+v", id, err)
}
```

### Verified Path
`body.properties.subnets[].properties.defaultOutboundAccess`

### Path Comparison
✅ **MATCH** - Predicted path matches verified path exactly.

## Provider Schema

### Schema Definition
```go
"subnet": {
    Type:       pluginsdk.TypeSet,
    Optional:   true,
    Computed:   true,
    ConfigMode: pluginsdk.SchemaConfigModeAttr,
    Elem: &pluginsdk.Resource{
        Schema: map[string]*pluginsdk.Schema{
            "default_outbound_access_enabled": {
                Type:     pluginsdk.TypeBool,
                Default:  true,
                Optional: true,
            },
            // ... other fields
        },
    },
},
```

**Key Properties:**
- Type: `Bool`
- Default: `true`
- Optional: `true`
- ForceNew: `false` (not specified, so defaults to false)
- No DiffSuppressFunc
- No ValidateFunc
- No ConflictsWith, RequiredWith, ExactlyOneOf, or AtLeastOneOf

## Azure API Schema

### Query Result
```
body.properties.subnets: List(ObjectWithOptionalAttrs(map[string]Type{
    // ... other properties
    "properties": ObjectWithOptionalAttrs(map[string]Type{
        "defaultOutboundAccess": Bool,
        // ... other properties
    }, []string{"addressPrefix", "addressPrefixes", "applicationGatewayIPConfigurations", 
                "defaultOutboundAccess", "delegations", "ipAllocations", ...})
    // ... other properties
}))
```

**Key Properties:**
- Type: `Bool`
- Located at: `body.properties.subnets[].properties.defaultOutboundAccess`
- Optional: Yes (included in the optional attributes list)

## Hidden Fields
None. The field is explicitly configured by users with no hidden values added by the provider.

## Mapping

### Terraform (snake_case) → Azure API (camelCase)
- `default_outbound_access_enabled` → `defaultOutboundAccess`

## Special Handling

### Default Value
The provider schema specifies `Default: true`, which is replicated using Terraform's `optional(bool, true)` syntax in the variable type definition. This ensures that when the field is not specified, it defaults to `true`.

**Implementation in variables.tf:**
```hcl
variable "subnet" {
  type = set(object({
    default_outbound_access_enabled = optional(bool, true)  # <- Applied default here
    # ... other fields
  }))
  # ...
}
```

### No ForceNew Behavior
The field does not have `ForceNew: true` in the schema, and there's no CustomizeDiff logic for this field. Changes to this value do not require resource replacement - they can be updated in place.

### No Validation Required
The field is a simple boolean with no additional validation logic in the provider. Type checking is sufficient.

### Update Behavior
Verified in `resourceVirtualNetworkUpdate` - the field can be updated:
```go
// From resourceVirtualNetworkUpdate
if d.HasChange("subnet") {
    subnets, routeTables, err := expandVirtualNetworkSubnets(ctx, *client, d.Get("subnet").(*pluginsdk.Set).List(), *id)
    // ... (same expand function that sets DefaultOutboundAccess)
    payload.Properties.Subnets = subnets
    // ... update call
}
```

## Implementation

### Shadow Implementation
```hcl
locals {
  body = {
    properties = {
      subnets = (var.subnet != null && length(var.subnet) > 0) ? [
        for subnet in var.subnet : {
          name = subnet.name
          properties = merge(
            length(subnet.address_prefixes) == 1 ? {
              addressPrefix = subnet.address_prefixes[0]
            } : {
              addressPrefixes = subnet.address_prefixes
            },
            {
              defaultOutboundAccess = subnet.default_outbound_access_enabled  # <- Implemented here
              # ... other fields
            }
          )
        }
      ] : null
    }
  }
}
```

## Deferred Work Completion
Checked `following.md` - file does not exist, so no deferred work to complete.

## Critical Review & Edge Case Analysis

### Null Semantics
- **When field is not set (defaults to true via optional):** The field will have value `true`, which is assigned to `defaultOutboundAccess = true` in the API
- **When explicitly set to true:** Same as default case
- **When explicitly set to false:** Assigned as `defaultOutboundAccess = false`
- **Idempotency:** ✅ Boolean values are inherently idempotent

### Edge Cases
1. **Empty subnet list:** The conditional `(var.subnet != null && length(var.subnet) > 0)` handles this - no subnets property sent when list is empty
2. **Default value application:** The `optional(bool, true)` syntax in the variable type ensures the default is applied correctly when users don't specify the field
3. **Boolean false vs null:** Since we use `optional(bool, true)`, the field is never null within a subnet object - it's always a boolean (true or false)

### Safe References
✅ All references are safe:
- `subnet.default_outbound_access_enabled` is accessed within the subnet loop, where subnet is guaranteed to be non-null
- The field itself is a boolean (never null due to optional() with default), so no additional null checking needed

### Idempotency Verification
✅ Implementation is idempotent:
- Boolean values are deterministic
- No order-dependent operations
- No dynamic computations that could vary between runs
- Direct field assignment with no transformations

## Checklist

- ✅ Property in correct local (`body.properties.subnets[].properties.defaultOutboundAccess`)
- ✅ Default value replicated using `optional(bool, true)` in variable type
- ✅ No ForceNew behavior (field can be updated in place)
- ✅ No validations required (simple boolean type)
- ✅ No hidden fields
- ✅ No deferred work in following.md (file doesn't exist)
- ✅ No deferred work from following.md (file doesn't exist)
- ✅ Critical review performed (null semantics, edge cases, idempotency, safe references)
- ✅ Edge Case Analysis documented
- ✅ Proof document created
- ✅ Implementation matches EXACT provider behavior (no approximations or simplifications)
- ✅ Self-Review: Only implemented Task #23 (default_outbound_access_enabled), did not touch other subnet fields

---

## ✅ CHECKER VALIDATION - APPROVED

**Checked by:** Checker Agent
**Date:** 2026-01-06
**Task:** #23 - subnet.default_outbound_access_enabled

### Validation Results

✅ **ForceNew Logic:** Not applicable (field has ForceNew: false, can be updated in place)
✅ **Stable Keys:** Not applicable (field not in replace_triggers_external_values)
✅ **Phase Detection:** Field correctly placed in local.body (Create phase)
✅ **Type Conversion:** Correct boolean type, no conversion needed
✅ **Null Handling:** Correctly uses optional(bool, true) to provide default value
✅ **Validations:** None required (simple boolean field, type checking sufficient)
✅ **Default Value Implementation:** Correctly uses PREFERRED method optional(bool, true) in object type (executor.md lines 148)
✅ **Deferred Work Completion:** No deferred work for this task (following.md doesn't exist)
✅ **Deferred Work Recording:** No deferrals made
✅ **Edge Cases:** All edge cases properly analyzed and handled

### Compliance Statement

This implementation EXACTLY replicates the provider behavior as required by `executor.md`. The default value is implemented using the PREFERRED method `optional(bool, true)` in the nested object type definition. No deviations, simplifications, or "safer alternatives" were found.

**Status:** APPROVED ✅

---
