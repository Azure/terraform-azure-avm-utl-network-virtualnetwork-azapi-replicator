# Task #2 - resource_group_name Argument Migration

## Summary
Migrated the root-level `resource_group_name` argument from `azurerm_virtual_network` to `azapi_resource`. This field is a required, ForceNew string that identifies the parent resource group. In azapi_resource, it maps to `parent_id` (not in body). The `resource_group_id` variable was already created in Task #1.

## Shadow Implementation

```hcl
# migrate_variables.tf
variable "resource_group_id" {  # <-
  type        = string  # <-
  description = "The resource ID of the resource group where the virtual network will be created. Required for azapi_resource parent_id."  # <-
  nullable    = false  # <-
}  # <-
```

```hcl
# migrate_main.tf
locals {
  azapi_header = {
    # ... other fields ...
    parent_id = var.resource_group_id  # <-
    # ... other fields ...
  }
}
```

```hcl
# variables.tf - existing variable (for validation replication)
variable "resource_group_name" {  # <-
  type        = string  # <-
  description = "(Required) The name of the resource group in which to create the virtual network. Changing this forces a new resource to be created."  # <-
  nullable    = false  # <-
  
  validation {  # <-
    condition     = can(regex("^[-\\w._()]+$", var.resource_group_name)) && length(var.resource_group_name) > 0 && length(var.resource_group_name) <= 90 && !can(regex("\\.$", var.resource_group_name))  # <-
    error_message = "The resource_group_name may only contain alphanumeric characters, dash, underscores, parentheses and periods. It must be between 1 and 90 characters in length and cannot end with a period."  # <-
  }  # <-
}  # <-
```

## Create Phase Verification

The Virtual Network resource follows a **single-phase creation pattern**. The `resource_group_name` is NOT part of the API payload sent to Azure.

**Evidence from Create method:**

```go
func resourceVirtualNetworkCreate(d *pluginsdk.ResourceData, meta interface{}) error {
	client := meta.(*clients.Client).Network.VirtualNetworks
	subscriptionId := meta.(*clients.Client).Account.SubscriptionId
	ctx, cancel := timeouts.ForCreate(meta.(*clients.Client).StopContext, d)
	defer cancel()

	// resource_group_name is used ONLY to construct the resource ID
	id := commonids.NewVirtualNetworkID(subscriptionId, d.Get("resource_group_name").(string), d.Get("name").(string))
	
	// ... existing check ...
	
	vnet := virtualnetworks.VirtualNetwork{
		Name:             pointer.To(id.VirtualNetworkName),
		ExtendedLocation: expandEdgeZoneModel(d.Get("edge_zone").(string)),
		Location:         pointer.To(location.Normalize(d.Get("location").(string))),
		Properties:       vnetProperties,  // resource_group_name NOT in properties
		Tags:             tags.Expand(d.Get("tags").(map[string]interface{})),
	}
	
	// resource_group_name is NOT assigned to vnet object - only used in ID construction
	if err := client.CreateOrUpdateThenPoll(ctx, id, vnet); err != nil {
		return fmt.Errorf("creating %s: %+v", id, err)
	}
	
	// ... rest of method ...
}
```

**Pattern:** Single-phase - primary `CreateOrUpdateThenPoll` only.

**Field Classification:** The `resource_group_name` is used during the **Create phase** but is NOT part of the API request body. It's used solely to construct the Azure Resource Manager ID which determines the API endpoint URL.

**Decision:** Map to `parent_id` in `local.azapi_header` (NOT in body). The `parent_id` must be the full resource ID of the resource group in format: `/subscriptions/{subscriptionId}/resourceGroups/{resourceGroupName}`.

## Assignment Path Verification

**Predicted Path:** Parent ID in azapi_resource (not in body)

**Evidence from Create method:**

```go
// resource_group_name is used to build the resource ID
id := commonids.NewVirtualNetworkID(subscriptionId, d.Get("resource_group_name").(string), d.Get("name").(string))

// The vnet object structure does NOT include resource_group_name
vnet := virtualnetworks.VirtualNetwork{
	Name:             pointer.To(id.VirtualNetworkName),
	ExtendedLocation: expandEdgeZoneModel(d.Get("edge_zone").(string)),
	Location:         pointer.To(location.Normalize(d.Get("location").(string))),
	Properties:       vnetProperties,  // No resource group field here
	Tags:             tags.Expand(d.Get("tags").(map[string]interface{})),
}

// The ID (which includes resource group) is passed to the API endpoint URL, not in the body
if err := client.CreateOrUpdateThenPoll(ctx, id, vnet); err != nil {
	return fmt.Errorf("creating %s: %+v", id, err)
}
```

The resource group name is embedded in the REST API endpoint URL path, not in the request body. In azapi_resource, this is represented by the `parent_id` parameter.

**Verified Path:** `parent_id` parameter in azapi_resource (not in body)

**Path Comparison:** ✅ Match - Both use resource group as a routing/addressing mechanism, not as body content.

## Provider Schema

**Source:** `terraform-provider-azurerm/internal/services/network/virtual_network_resource.go`

```go
"resource_group_name": commonschema.ResourceGroupName(),
```

**Expanded from commonschema.ResourceGroupName():**

```go
func ResourceGroupName() *schema.Schema {
	return &schema.Schema{
		Type:         schema.TypeString,
		Required:     true,
		ForceNew:     true,
		ValidateFunc: resourcegroups.ValidateName,
	}
}
```

**Key Properties:**
- **Type:** String
- **Required:** Yes
- **ForceNew:** Yes
- **Optional:** No
- **Computed:** No
- **Sensitive:** No
- **ValidateFunc:** `resourcegroups.ValidateName`

## Azure API Schema

**Resource Type:** `Microsoft.Network/virtualNetworks@2024-07-01`

**Property Path:** N/A - not in API body

**API Behavior:** The resource group is part of the REST API endpoint URL:
```
PUT https://management.azure.com/subscriptions/{subscriptionId}/resourceGroups/{resourceGroupName}/providers/Microsoft.Network/virtualNetworks/{virtualNetworkName}?api-version=2024-07-01
```

The resource group name is in the URL path, not in the request body.

## Hidden Fields

No hidden fields discovered for `resource_group_name`. The field is used solely for resource ID construction and API endpoint routing.

## Mapping

**Terraform (snake_case) → Azure API:**
- `resource_group_name` → Part of `parent_id` in azapi_resource
- `var.resource_group_name` (original) → `var.resource_group_id` (new variable for full resource ID)

**Transformation Logic:**
- AzureRM provider: Uses string name directly from `resource_group_name`
- AzAPI provider: Requires full resource ID format for `parent_id`
- Users must provide: `/subscriptions/{subscriptionId}/resourceGroups/{resourceGroupName}`

## Special Handling

### ForceNew Behavior

**Provider Schema:** `ForceNew: true`

**Implementation:** Not added to `replace_triggers_external_values` because `parent_id` is a root-level azapi_resource parameter. The AzAPI provider automatically handles ForceNew for `parent_id` - any change to `parent_id` triggers resource replacement by default.

**Evidence:** The azapi_resource schema treats `parent_id` as an immutable identifier that determines where the resource is created. Changing the parent resource group requires creating a new resource.

### Validation

**Provider Validation:** The schema uses `ValidateFunc: resourcegroups.ValidateName`

**Validation Implementation:**

```go
func ValidateName(v interface{}, k string) (warnings []string, errors []error) {
	value := v.(string)

	if len(value) > 90 {
		errors = append(errors, fmt.Errorf("%q may not exceed 90 characters in length", k))
	}

	if strings.HasSuffix(value, ".") {
		errors = append(errors, fmt.Errorf("%q may not end with a period", k))
	}

	if len(value) == 0 {
		errors = append(errors, fmt.Errorf("%q cannot be blank", k))
	} else if matched := regexp.MustCompile(`^[-\w._()]+$`).Match([]byte(value)); !matched {
		// regex pulled from https://docs.microsoft.com/en-us/rest/api/resources/resourcegroups/createorupdate
		errors = append(errors, fmt.Errorf("%q may only contain alphanumeric characters, dash, underscores, parentheses and periods", k))
	}

	return warnings, errors
}
```

**Validation Rules:**
1. Cannot be blank (length > 0)
2. Maximum length: 90 characters
3. Cannot end with a period (`.`)
4. May only contain: alphanumeric characters, dash (`-`), underscores (`_`), parentheses (`()`), and periods (`.`)

**Replication:** Added validation block to `variable "resource_group_name"` in `variables.tf` to replicate ALL validation rules from the provider.

**Note:** The `resource_group_id` variable does NOT need these validations because:
1. It's expected to be a full Azure Resource ID (different format)
2. Users typically obtain it from `azurerm_resource_group` data source or output
3. The validation applies to the resource group NAME, not the full ID

However, we preserve the original `resource_group_name` variable for backward compatibility and add validation to it.

### Architectural Note

**Two-Variable Pattern:**
- `var.resource_group_name` (existing in variables.tf): Original variable preserved for compatibility, receives validation
- `var.resource_group_id` (new in migrate_variables.tf): New variable for the full resource ID required by azapi_resource

Users can construct the `resource_group_id` from `resource_group_name` like:
```hcl
resource_group_id = "/subscriptions/${data.azurerm_client_config.current.subscription_id}/resourceGroups/${var.resource_group_name}"
```

Or use the resource group's ID directly:
```hcl
resource_group_id = azurerm_resource_group.example.id
```

## Critical Review & Edge Case Analysis

### Null Semantics
- **Resource group name cannot be null:** `nullable = false` ensures value is always provided
- **Resource group ID cannot be null:** `nullable = false` in migrate_variables.tf
- **Behavior:** Both variables are required - Terraform will error if not provided

### Boundary Conditions
- **Empty string:** Validation catches empty strings (length must be > 0)
- **Max length:** Validation enforces 90-character limit
- **Trailing period:** Validation prevents names ending with `.`
- **Invalid characters:** Regex validation ensures only allowed characters are used

### Idempotency
- **Resource group is immutable:** ForceNew = true means any change creates new resource
- **Same resource group, same resource:** Idempotent - applying same parent_id results in same resource
- **No ordering concerns:** Single scalar string value, no ordering issues

### Safe References
- **Direct reference:** `var.resource_group_id` is safely referenced - always has a value due to `nullable = false`
- **No nested access:** Simple string value, no nested property access needed
- **Type safety:** Strongly typed as string in both variables

### Edge Cases

1. **Case sensitivity:** Azure resource group names are case-insensitive, but Azure preserves the case you specify. Our pass-through approach maintains this behavior.

2. **Resource ID format validation:** We do NOT validate the `resource_group_id` format in this task. If users provide an incorrect format, Azure API will reject it with a clear error message. This matches the AzureRM provider behavior where resource_group_name is validated, but the construction of the full resource ID happens internally.

3. **Cross-subscription scenarios:** The `parent_id` can reference a resource group in any accessible subscription. This is handled naturally by accepting any valid resource ID format.

4. **Special characters in URL:** The resource group name is URL-encoded when used in API calls. The Azure SDK handles this automatically, so we don't need special handling.

5. **Non-existent resource group:** If the parent resource group doesn't exist, the Azure API will return a 404 error during resource creation. This matches the AzureRM provider behavior.

## Deferred Work Completion

Checked `following.md` - file does not exist yet. No deferred work for this task.

## Checklist

- ✅ Property in correct local (`azapi_header.parent_id`)
- ✅ ForceNew handled (implicit for root-level parent_id)
- ✅ All logic exactly replicated from provider (used for ID construction, not in body)
- ✅ Validations IMPLEMENTED in variables.tf (all rules from resourcegroups.ValidateName)
- ✅ Hidden fields checked (none - used only for routing)
- ✅ Deferred work in following.md: N/A
- ✅ Deferred work from following.md: None yet
- ✅ Critical review completed
- ✅ Edge Case Analysis completed
- ✅ Proof created
- ✅ Self-Review: Only validated and documented resource_group_name mapping to parent_id (no body changes)
- ✅ Variable `resource_group_id` already created in Task #1
- ✅ Validation added to existing `resource_group_name` variable

---

## ✅ CHECKER VALIDATION - APPROVED

**Checked by:** Checker Agent
**Date:** 2026-01-06
**Task:** #2 - resource_group_name

### Validation Results

✅ **Variable Creation:** `resource_group_id` variable correctly created in `migrate_variables.tf` with `type = string` and `nullable = false`
✅ **Parent ID Assignment:** Correctly assigned to `azapi_header.parent_id` (not in body), matching Azure REST API behavior
✅ **ForceNew Logic:** Correctly NOT added to `replace_triggers_external_values` - parent_id changes are implicitly ForceNew in azapi_resource
✅ **Validations:** All provider validations from `resourcegroups.ValidateName` correctly replicated in `variables.tf`:
  - Length validation (1-90 characters)
  - Character pattern validation (alphanumeric, dash, underscore, parentheses, periods)
  - Trailing period prohibition
✅ **Phase Detection:** Correctly identified as Create phase, used for ID construction only (not in API body)
✅ **Type Conversion:** String type correctly preserved
✅ **Null Handling:** `nullable = false` correctly set on both variables
✅ **Deferred Work Completion:** No deferred work for this task (following.md does not exist yet)
✅ **Deferred Work Recording:** No deferrals made by this task
✅ **Edge Cases:** Comprehensive edge case analysis including case sensitivity, URL encoding, non-existent resource groups, cross-subscription scenarios
✅ **Proof Document:** Complete with all required sections and Go code evidence

### Compliance Statement

This implementation EXACTLY replicates the provider behavior as required by `executor.md`. The `resource_group_name` is correctly mapped to `parent_id` for API endpoint routing, ForceNew is handled implicitly by azapi_resource, and all validations are implemented in variables.tf. The two-variable pattern (`resource_group_name` and `resource_group_id`) provides backward compatibility while meeting azapi_resource requirements.

**Status:** APPROVED ✅

---
