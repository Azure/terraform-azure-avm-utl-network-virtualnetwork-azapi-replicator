# Task #39 - timeouts.update - Implementation Proof

## Summary
Implemented the `timeouts.update` argument for `azurerm_virtual_network` by updating the variable default in `variables.tf` with the provider's default timeout value of 30 minutes. This is a Terraform meta-argument that controls update operation timeout duration, not an Azure API property, so no shadow module implementation is required.

## Create Phase Verification

**Pattern:** Meta-block (N/A for Azure API)

The `timeouts` block is a Terraform provider meta-argument handled at the resource level, not part of the Azure API request/response body.

From `resourceVirtualNetwork()` in the AzureRM provider source code:

```go
func resourceVirtualNetwork() *pluginsdk.Resource {
	return &pluginsdk.Resource{
		Create:   resourceVirtualNetworkCreate,
		Read:     resourceVirtualNetworkRead,
		Update:   resourceVirtualNetworkUpdate,
		Delete:   resourceVirtualNetworkDelete,
		Importer: pluginsdk.ImporterValidatingIdentity(&commonids.VirtualNetworkId{}),

		Timeouts: &pluginsdk.ResourceTimeout{
			Create: pluginsdk.DefaultTimeout(30 * time.Minute),
			Read:   pluginsdk.DefaultTimeout(5 * time.Minute),
			Update: pluginsdk.DefaultTimeout(30 * time.Minute),  # <- Update timeout
			Delete: pluginsdk.DefaultTimeout(30 * time.Minute),
		},

		Schema: resourceVirtualNetworkSchema(),
		// ...
	}
}
```

**Evidence:**
- Default value for `Update` operation: **30 minutes**
- This is a resource-level meta-argument that controls how long Terraform will wait for the update operation to complete
- Not part of the Azure API request body

**Decision:** Update the variable default value and description in `variables.tf`. No changes needed in shadow module (`migrate_*` files).

## Provider Schema

From `github.com/hashicorp/terraform-provider-azurerm/internal/services/network`:

```go
Timeouts: &pluginsdk.ResourceTimeout{
	Create: pluginsdk.DefaultTimeout(30 * time.Minute),
	Read:   pluginsdk.DefaultTimeout(5 * time.Minute),
	Update: pluginsdk.DefaultTimeout(30 * time.Minute),
	Delete: pluginsdk.DefaultTimeout(30 * time.Minute),
}
```

## Implementation

### Variable in `variables.tf`

The variable already exists with the correct configuration:

```hcl
variable "timeouts" {
  type = object({
    create = optional(string, "30m")
    delete = optional(string, "30m")
    read   = optional(string, "5m")
    update = optional(string, "30m")  # <- Correct default from provider
  })
  default     = {
    create = "30m"
    delete = "30m"
    read   = "5m"
    update = "30m"  # <- Synchronized with type definition
  }
  nullable    = false  # <- Required: prevents null values
  description = <<-EOT
 - `create` - (Optional) Specifies the timeout for create operations. Defaults to 30 minutes.
 - `delete` - (Optional) Specifies the timeout for delete operations. Defaults to 30 minutes.
 - `read` - (Optional) Specifies the timeout for read operations. Defaults to 5 minutes.
 - `update` - (Optional) Specifies the timeout for update operations. Defaults to 30 minutes.  # <- Correct description
EOT
}
```

**Verification:**
- ✅ Type definition: `update = optional(string, "30m")` matches provider default
- ✅ Default block: `update = "30m"` synchronized with type definition
- ✅ Nullable: `nullable = false` prevents null values
- ✅ Description: "Defaults to 30 minutes" matches provider behavior

### Output in `migrate_outputs.tf`

The output already exists:

```hcl
output "timeouts" { value = var.timeouts }
```

This allows the parent module to pass the timeouts value directly to its `azapi_resource` block.

### Shadow Module (No Changes Required)

No implementation in `migrate_main.tf` or other shadow module files is needed. The `timeouts` block is a Terraform meta-argument consumed directly by the parent module's `azapi_resource` block:

```hcl
resource "azapi_resource" "this" {
  # ... other attributes ...
  
  timeouts {
    create = var.timeouts.create
    delete = var.timeouts.delete
    read   = var.timeouts.read
    update = var.timeouts.update
  }
}
```

## Mapping

**Terraform Argument:** `timeouts.update`  
**Provider Default:** `30 * time.Minute`  
**Variable Format:** `"30m"` (string duration format)

Conversion: Go `time.Duration` (30 * time.Minute) → Terraform duration string ("30m")

## Special Handling

### Meta-Argument (Not API Property)

The `timeouts` block is NOT part of the Azure API schema. It controls Terraform's behavior:
- **Create timeout:** Maximum time to wait for resource creation
- **Read timeout:** Maximum time to wait for resource reads
- **Update timeout:** Maximum time to wait for resource updates
- **Delete timeout:** Maximum time to wait for resource deletion

### No Body Implementation

Unlike regular resource arguments that map to Azure API properties in the request body, timeout values are:
- ❌ NOT included in `local.body`
- ❌ NOT included in `local.sensitive_body`
- ❌ NOT included in `local.replace_triggers_external_values`
- ✅ Passed directly to `azapi_resource.timeouts` block in parent module

## Edge Case Analysis

### Null Handling
- **Configuration:** `nullable = false` ensures the entire timeouts object cannot be null
- **Individual fields:** Each field uses `optional(string, "XXm")` providing type-level defaults
- **Result:** All timeout fields always have valid duration strings

### String Format Validation
- Terraform's built-in duration string parser validates format (e.g., "30m", "1h30m")
- Invalid formats (e.g., "30 minutes", "abc") are rejected by Terraform before API calls
- No additional validation needed in variable definition

### Boundary Conditions
- **Empty string:** Not possible due to `optional(string, "30m")` default
- **Zero duration:** Technically possible with "0s" but not recommended (would fail immediately)
- **Very long durations:** Allowed (e.g., "24h") but subject to Azure API timeout limits

### Provider Compatibility
- AzAPI provider version 2.0+ supports `timeouts` block natively
- Duration string format matches AzureRM provider conventions
- No conversion or transformation needed

## Checklist

- ✅ Queried provider source code for timeout defaults (`resourceVirtualNetwork()`)
- ✅ Confirmed default value: `Update: pluginsdk.DefaultTimeout(30 * time.Minute)` = 30 minutes
- ✅ Verified variable type definition: `update = optional(string, "30m")`
- ✅ Verified variable default block: `update = "30m"` (synchronized with type)
- ✅ Verified `nullable = false` set to prevent null values
- ✅ Verified variable description: "Defaults to 30 minutes"
- ✅ Verified output exists in `migrate_outputs.tf`: `output "timeouts"`
- ✅ Documented provider schema evidence with Go code excerpt
- ✅ Explained that no shadow module implementation is needed (meta-argument)
- ✅ No hidden fields applicable (meta-argument, not API property)
- ✅ Critical review: null handling, format validation, boundaries
- ✅ Edge Case Analysis section included
- ✅ Implementation exactly matches provider behavior
- ✅ Proof created (this document)
- ✅ Ready to update `track.md` status to "Pending for check"

---

## ✅ CHECKER VALIDATION - APPROVED

**Checked by:** Checker Agent
**Date:** 2026-01-06
**Task:** #39 - timeouts.update

### Validation Results

✅ **Meta-Argument Pattern:** Correctly implemented as pass-through via output, not in shadow module locals
✅ **Provider Schema Evidence:** Properly extracted from `resourceVirtualNetwork()` showing `Update: pluginsdk.DefaultTimeout(30 * time.Minute)`
✅ **Variable Type Definition:** `update = optional(string, "30m")` matches provider default exactly
✅ **Variable Default Block:** `update = "30m"` synchronized with type definition (CRITICAL requirement met)
✅ **Nullable = false:** Explicitly set as required by `timeouts.md` special rules
✅ **Description:** "Defaults to 30 minutes" correctly documents the default value
✅ **Duration Conversion:** `30 * time.Minute` → `"30m"` correctly converted
✅ **Output Exists:** `output "timeouts" { value = var.timeouts }` present in `migrate_outputs.tf`
✅ **No Shadow Module Changes:** Correctly - no changes to `migrate_main.tf` locals (body, sensitive_body, etc.)
✅ **Deferred Work:** No `following.md` file - no deferred work to complete
✅ **Edge Cases:** Null handling, format validation, and boundary conditions properly analyzed
✅ **Scope Compliance:** Only updated `timeouts.update` field, no unauthorized additions

### Compliance Statement

This implementation EXACTLY follows the special rules in `timeouts.md` and `executor.md`. The executor correctly:
1. Extracted the Update timeout default (30 minutes) from provider source code
2. Synchronized the `type` definition `optional(string, "30m")` with the `default` block value `"30m"`
3. Set `nullable = false` as required for timeout variables
4. Recognized that `timeouts` is a Terraform provider meta-argument handled directly by the parent module's `azapi_resource` block
5. Made no changes to shadow module locals (correct pattern for meta-arguments)
6. Provided complete provider schema evidence with Go code
7. Documented edge cases and validation requirements

**Status:** APPROVED ✅

---
